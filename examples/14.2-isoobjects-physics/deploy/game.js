function printStackTrace(t){t=t||{guess:!0};for(var e=t.e||null,i=!!t.guess,n=new printStackTrace.implementation,s=n.run(e),o=i?n.guessAnonymousFunctions(s):s,r=0;4>r;r++)o.shift();return o}printStackTrace.implementation=function(){},printStackTrace.implementation.prototype={run:function(t){t=t||this.createException();var e=this.mode(t);return e==="other"?this.other(arguments.callee):this[e](t)},createException:function(){try{return this.undef(),null}catch(t){return t}},mode:function(t){return this._mode=t.arguments&&t.stack?"chrome":t.message&&typeof window!="undefined"&&window.opera?t.stacktrace?"opera10":"opera":t.stack?"firefox":"other"},instrumentFunction:function(t,e,i){t=t||window;var n=t[e];t[e]=function(){return i.call(this,printStackTrace().slice(4)),t[e]._instrumented.apply(this,arguments)},t[e]._instrumented=n},deinstrumentFunction:function(t,e){t[e].constructor===Function&&t[e]._instrumented&&t[e]._instrumented.constructor===Function&&(t[e]=t[e]._instrumented)},chrome:function(t){var e=(t.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");return e.pop(),e},firefox:function(t){return t.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n")},opera10:function(t){var e,i,n,s=t.stacktrace,o=s.split("\n"),r="{anonymous}",a=/.*line (\d+), column (\d+) in ((<anonymous function\:?\s*(\S+))|([^\(]+)\([^\)]*\))(?: in )?(.*)\s*$/i;for(e=2,i=0,n=o.length;n-2>e;e++)if(a.test(o[e])){var h=RegExp.$6+":"+RegExp.$1+":"+RegExp.$2,u=RegExp.$3;u=u.replace(/<anonymous function\:?\s?(\S+)?>/g,r),o[i++]=u+"@"+h}return o.splice(i,o.length-i),o},opera:function(t){var e,i,n,s=t.message.split("\n"),o="{anonymous}",r=/Line\s+(\d+).*script\s+(http\S+)(?:.*in\s+function\s+(\S+))?/i;for(e=4,i=0,n=s.length;n>e;e+=2)r.test(s[e])&&(s[i++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:o+"()@"+RegExp.$2+":"+RegExp.$1)+" -- "+s[e+1].replace(/^\s+/,""));return s.splice(i,s.length-i),s},other:function(t){var e,i,n="{anonymous}",s=/function\s*([\w\-$]+)?\s*\(/i,o=[],r=10;while(t&&r>o.length)e=s.test(t+"")?RegExp.$1||n:n,i=Array.prototype.slice.call(t.arguments||[]),o[o.length]=e+"("+this.stringifyArguments(i)+")",t=t.caller;return o},stringifyArguments:function(t){for(var e=Array.prototype.slice,i=0;t.length>i;++i){var n=t[i];n===void 0?t[i]="undefined":n===null?t[i]="null":n.constructor&&(n.constructor===Array?t[i]=3>n.length?"["+this.stringifyArguments(n)+"]":"["+this.stringifyArguments(e.call(n,0,1))+"..."+this.stringifyArguments(e.call(n,-1))+"]":n.constructor===Object?t[i]="#object":n.constructor===Function?t[i]="#function":n.constructor===String&&(t[i]='"'+n+'"'))}return t.join(",")},sourceCache:{},ajax:function(t){var e=this.createXMLHTTPObject();if(e)return e.open("GET",t,!1),e.send(""),e.responseText},createXMLHTTPObject:function(){for(var t,e=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],i=0;e.length>i;i++)try{return t=e[i](),this.createXMLHTTPObject=e[i],t}catch(n){}},isSameDomain:function(t){return t.indexOf(location.hostname)!==-1},getSource:function(t){return t in this.sourceCache||(this.sourceCache[t]=this.ajax(t).split("\n")),this.sourceCache[t]},guessAnonymousFunctions:function(t){for(var e=0;t.length>e;++e){var i=/\{anonymous\}\(.*\)@(\w+:\/\/([\-\w\.]+)+(:\d+)?[^:]+):(\d+):?(\d+)?/,n=t[e],s=i.exec(n);if(s){var o=s[1],r=s[4],a=s[7]||0;if(o&&this.isSameDomain(o)&&r){var h=this.guessAnonymousFunction(o,r,a);t[e]=n.replace("{anonymous}",h)}}}return t},guessAnonymousFunction:function(t,e){var i;try{i=this.findFunctionName(this.getSource(t),e)}catch(n){i="getSource failed with url: "+t+", exception: "+(n+"")}return i},findFunctionName:function(t,e){for(var i,n,s=/function\s+([^(]*?)\s*\(([^)]*)\)/,o=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*function\b/,r=/['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*(?:eval|new Function)\b/,a="",h=10,u=0;h>u;++u)if(i=t[e-u]){if(a=i+a,n=o.exec(a),n&&n[1])return n[1];if(n=s.exec(a),n&&n[1])return n[1];if(n=r.exec(a),n&&n[1])return n[1]}return"(?)"}},ige=null,igeVersion="1.1.0",igeClassStore={},igeDebug={node:typeof module!="undefined"&&module.exports!==void 0,level:["log","warning","error"],stacks:!0,throwErrors:!0,timing:!0},igeDebug.node&&(igeDebug.util=require("util")),Object.defineProperty(Object.prototype,"tween",{enumerable:!1,writable:!0,configurable:!0}),Object.prototype.tween=function(t,e,i){var n=(new $i_47).targetObj(this).properties(t).duration(e);return i&&(i.beforeTween&&n.beforeTween(i.beforeTween),i.afterTween&&n.afterTween(i.afterTween),i.easing&&n.easing(i.easing),i.startTime&&n.startTime(i.startTime)),n},Object.defineProperty(Array.prototype,"clone",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.clone=function(){var t,e=[];for(t in this)this.hasOwnProperty(t)&&(e[t]=this[t]instanceof Array?this[t].clone():this[t]);return e},Object.defineProperty(Array.prototype,"pull",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.pull=function(t){var e=this.indexOf(t);return e>-1?(this.splice(e,1),e):-1},Object.defineProperty(Array.prototype,"each",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.each=function(t){var e,i=this.length;for(e=0;i>e;e++)t(this[e])},Object.defineProperty(Array.prototype,"eachReverse",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.eachReverse=function(t){var e,i=this.length;for(e=i-1;e>=0;e--)t(this[e])},Object.defineProperty(Array.prototype,"eachIsolated",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.eachIsolated=function(t){var e,i=[],n=i.length;for(e=0;n>e;e++)i[e]=this[e];for(e=0;n>e;e++)t(i[e])},Object.defineProperty(Math,"PI180",{enumerable:!1,writable:!0,configurable:!0}),Math.PI180=Math.PI/180,Object.defineProperty(Math,"PI180R",{enumerable:!1,writable:!0,configurable:!0}),Math.PI180R=180/Math.PI,Object.defineProperty(Math,"radians",{enumerable:!1,writable:!0,configurable:!0}),Math.radians=function(t){return t*Math.PI180},Object.defineProperty(Math,"degrees",{enumerable:!1,writable:!0,configurable:!0}),Math.degrees=function(t){return t*Math.PI180R},Object.defineProperty(Math,"distance",{enumerable:!1,writable:!0,configurable:!0}),Math.distance=function(t,e,i,n){return Math.sqrt((t-i)*(t-i)+(e-n)*(e-n))};var disableContextMenu=function(t){t!==null&&(t.oncontextmenu=function(){return!1})};Array.prototype.indexOf||(Object.defineProperty(Array.prototype,"indexOf",{enumerable:!1,writable:!0,configurable:!0}),Array.prototype.indexOf=function(t){var e,i=this.length;for(e=0;i>e;e++)if(this[e]===t)return e;return-1}),requestAnimFrame=typeof window!="undefined"?function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(function(){t((new Date).getTime())},1e3/60)}}():function(){return function(t){setTimeout(function(){t((new Date).getTime())},1e3/60)}}(),typeof console=="object"?typeof console.log=="function"&&(console.info===void 0&&(console.info=console.log),console.warn===void 0&&(console.warn=console.log)):console={log:function(){},warn:function(){},info:function(){},error:function(){}},typeof JSON.decycle!="function"&&(JSON.decycle=function decycle(t){"use strict";var e=[],i=[];return function n(t,s){var o,r,a;switch(typeof t){case"object":if(!t)return null;for(o=0;e.length>o;o+=1)if(e[o]===t)return{$ref:i[o]};if(e.push(t),i.push(s),Object.prototype.toString.apply(t)==="[object Array]")for(a=[],o=0;t.length>o;o+=1)a[o]=n(t[o],s+"["+o+"]");else{a={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=n(t[r],s+"["+JSON.stringify(r)+"]"))}return a;case"number":case"string":case"boolean":return t}}(t,"$")}),typeof JSON.retrocycle!="function"&&(JSON.retrocycle=function retrocycle($){"use strict";var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function rez(value){var i,item,name,path;if(value&&typeof value=="object")if(Object.prototype.toString.apply(value)==="[object Array]")for(i=0;value.length>i;i+=1)item=value[i],item&&typeof item=="object"&&(path=item.$ref,typeof path=="string"&&px.test(path)?value[i]=eval(path):rez(item));else for(name in value)typeof value[name]=="object"&&(item=value[name],item&&(path=item.$ref,typeof path=="string"&&px.test(path)?value[name]=eval(path):rez(item)))}($),$});var $i_2=function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/,i=function(){},n=function(t,e,i){var n,s="";if(e=e||"log",i!==void 0&&console.warn(i),(e==="warning"||e==="error")&&igeDebug.stacks&&(igeDebug.node?(n=Error().stack,console.log("Stack:",n)):typeof printStackTrace=="function"&&console.log("Stack:",printStackTrace().join("\n ---- "))),e==="error"){if(igeDebug.throwErrors)throw s+"IGE *"+e+"* ["+(this._classId||this.prototype._classId)+"] : "+t;console.log(s+"IGE *"+e+"* ["+(this._classId||this.prototype._classId)+"] : "+t)}else console.log(s+"IGE *"+e+"* ["+(this._classId||this.prototype._classId)+"] : "+t);return this},s=function(){return this._classId},o=function(t,e){var i=new t(this,e);return this[i.componentId]=i,this._components.push(i),this},r=function(t){return this[t]&&this[t].destroy&&this[t].destroy(),this._components&&this._components.pull(this[t]),delete this[t],this},a=function(t,e){var i,n=t.prototype||t;for(i in n)n.hasOwnProperty(i)&&(e||this[i]===void 0)&&(this[i]=n[i]);return this},h=function(t,e){return t!==void 0?e!==void 0?(this._data[t]=e,this):this._data[t]:void 0};return i.extend=function(){function i(){this._data={},!t&&this.init&&(this._components=[],typeof ige!="undefined"&&(this.ige=ige),this.init.apply(this,arguments))}var u,l,c,d,p,_,y,f=this.prototype,g=arguments[arguments.length-1],m=arguments[0];if(!g.classId)throw console.log(g),"Cannot create a new class without giving the class a classId property!";if(igeClassStore[g.classId])throw'Cannot create class with classId "'+g.classId+'" because a class with that ID has already been created!';t=!0,l=new this,t=!1;for(u in g)typeof g[u]=="function"&&typeof f[u]=="function"&&e.test(g[u])?(l["__"+u]=g[u],l[u]=function(t,e){return function(){var i,n=this._super;return this._super=f[t],i=e["__"+t].apply(this,arguments),this._super=n,i}}(u,l)):l[u]=g[u];if(arguments.length>1&&m&&m.length)for(p=0;m.length>p;p++){c=m[p],y=c.extension.prototype||c.extension,d=c.overwrite;for(_ in y)y.hasOwnProperty(_)&&(d||l[_]===void 0)&&(l[_]=y[_])}return i.prototype=l,i.prototype.constructor=i,i.extend=arguments.callee,i.prototype.log=n,i.prototype.data=h,i.prototype.classId=s,i.prototype._classId=g.classId||"$i_2",i.prototype.addComponent=o,i.prototype.removeComponent=r,i.prototype.implement=a,igeClassStore[g.classId]=i,i},i}();typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_2);var $i_3=$i_2.extend({classId:"$i_3",on:function(t,e,i,n,s){var o,r,a,h,u,l,c,d,p,_=this;if(this._eventListeners=this._eventListeners||{},typeof e=="function"){if(typeof t=="string")return o={call:e,context:i,oneShot:n,sendEventName:s},h=this._eventListeners[t]=this._eventListeners[t]||[],r=!0,a=h.indexOf(o),a>-1&&(r=!1),r&&h.push(o),o;if(t.length){u=[],u[0]=0,u[1]=0,u[3]=function(){u[1]++,u[0]===u[1]&&e.apply(i||_)};for(l in t)t.hasOwnProperty(l)&&(c=t[l],d=c[0],p=c[1],u[0]++,d.on(p,u[3],null,!0,!0))}}else typeof t!="string"&&(t="*Multi-Event*"),this.log('Cannot register event listener for event "'+t+'" because the passed callback is not a function!',"error")},emit:function(t,e){if(this._eventListeners&&this._eventListeners[t]){var i,n,s,o,r,a,h=this._eventListeners[t].length,u=this._eventListeners[t].length-1;if(h){if(i=[],typeof e=="object"&&e!==null&&e[0]!==null&&e[0]!==void 0)for(n in e)e.hasOwnProperty(n)&&(i[n]=e[n]);else i=[e];s=!1,this._eventListeners._processing=!0;while(h--)o=u-h,r=this._eventListeners[t][o],r.sendEventName&&(i=[t]),a=r.call.apply(r.context||this,i),a===!0&&(s=!0),r.oneShot&&(this.off(t,r),u--);if(this._eventListeners._processing=!1,this._processRemovals(),s)return 1}}},_processRemovals:function(){if(this._eventListeners){var t,e,i,n=this._eventListeners._removeQueue;if(n){t=n.length;while(t--)e=n[t],i=this.off(e[0],e[1]),n[2]&&n[2](i)}delete this._eventListeners._removeQueue}},off:function(t,e,i){if(this._eventListeners){if(this._eventListeners._processing)return this._eventListeners._removeQueue=this._eventListeners._removeQueue||[],this._eventListeners._removeQueue.push([t,e,i]),-1;if(this._eventListeners[t]){var n=this._eventListeners[t].indexOf(e);if(n>-1)return this._eventListeners[t].splice(n,1),i&&i(!0),!0;this.log('Failed to cancel event listener for event named "'+t+'" !',"warning",e)}else this.log("Failed to cancel event listener!")}return i&&i(!1),!1},eventList:function(){return this._eventListeners}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_3);var $i_5=function(t,e,i,n){return n===void 0?this._floor=!0:this.floor(n),this.x=t=t!==void 0?t:0,this.y=e=e!==void 0?e:0,this.z=i=i!==void 0?i:0,this._floor?(this.x2=Math.floor(t/2),this.y2=Math.floor(e/2),this.z2=Math.floor(i/2)):(this.x2=t/2,this.y2=e/2,this.z2=i/2),this};$i_5.prototype.floor=function(t){return t!==void 0?(this._floor=t,this):this._floor},$i_5.prototype.compare=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},$i_5.prototype.toIso=function(){var t=this.x-this.y,e=-this.z*1.2247+(this.x+this.y)*.5;return{x:t,y:e}},$i_5.prototype.thisToIso=function(){var t=this.toIso();return this.x=t.x,this.y=t.y,this.z=0,this},$i_5.prototype.to2d=function(){var t=this.y+this.x/2,e=this.y-this.x/2;return{x:t,y:e}},$i_5.prototype.thisTo2d=function(){var t=this.to2d();return this.x=t.x,this.y=t.y,this.z=0,this},$i_5.prototype.addPoint=function(t){return new $i_5(this.x+t.x,this.y+t.y,this.z+t.z)},$i_5.prototype.thisAddPoint=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},$i_5.prototype.minusPoint=function(t){return new $i_5(this.x-t.x,this.y-t.y,this.z-t.z)},$i_5.prototype.thisMinusPoint=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},$i_5.prototype.multiply=function(t,e,i){return new $i_5(this.x*t,this.y*e,this.z*i)},$i_5.prototype.thisMultiply=function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},$i_5.prototype.divide=function(t,e,i){return new $i_5(this.x/t,this.y/e,this.z/i)},$i_5.prototype.thisDivide=function(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this},$i_5.prototype.clone=function(){return new $i_5(this.x,this.y,this.z)},$i_5.prototype.interpolate=function(t,e,i,n){var s=t.x-this.x,o=t.y-this.y,r=t.z-this.z,a=n-e,h=a-(i-e),u=h/a;return new $i_5(t.x-s*u,t.y-o*u,t.z-r*u)},$i_5.prototype.toString=function(t){return t===void 0&&(t=2),this.x.toFixed(t)+","+this.y.toFixed(t)+","+this.z.toFixed(t)},typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_5);var $i_6=$i_2.extend({classId:"$i_6",init:function(){this._poly=[],this._scale=new $i_5(1,1,1)},scale:function(t,e){return t!==void 0&&e!==void 0?(this._scale.x=t,this._scale.y=e,this):this._scale},addPoint:function(t,e){return this._poly.push(new $i_5(t,e,0)),this},length:function(){return this._poly.length},pointInPoly:function(t){var e,i=this._poly,n=i.length,s=n-1,o=0;for(e=0;n>e;s=e++)i[e].y>t.y!=i[s].y>t.y&&(i[s].x-i[e].x)*(t.y-i[e].y)/(i[s].y-i[e].y)+i[e].x>t.x&&(o=!o);return o},render:function(t){var e=this._poly,n=e.length,s=this._scale.x,o=this._scale.y;for(t.beginPath(),t.moveTo(e[0].x*s,e[0].y*o),i=1;n>i;i++)t.lineTo(e[i].x*s,e[i].y*o);return t.lineTo(e[0].x*s,e[0].y*o),t.stroke(),this}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_6);var $i_7=function(t,e,i,n){return this.x=t=t!==void 0?t:0,this.y=e=e!==void 0?e:0,this.width=i=i!==void 0?i:0,this.height=n=n!==void 0?n:0,this};$i_7.prototype.compare=function(t){return t&&this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},$i_7.prototype.xyInside=function(t,e){return t>=this.x&&e>this.y&&this.x+this.width>=t&&this.y+this.height>=e},$i_7.prototype.pointInside=function(t){return x>=this.x&&t.y>this.y&&this.x+this.width>=t.x&&this.y+this.height>=t.y},$i_7.prototype.rectIntersect=function(t){if(t){var e=this.x,i=this.y,n=this.width,s=this.height,o=t.x,r=t.y,a=t.width,h=t.height,u=e+n,l=i+s,c=o+a,d=r+h;if(c>e&&u>o&&d>i&&l>r)return!0}return!1},$i_7.prototype.toString=function(t){return t===void 0&&(t=2),this.x.toFixed(t)+","+this.y.toFixed(t)+","+this.width.toFixed(t)+","+this.height.toFixed(t)},typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_7);var $i_8=function(){this.matrix=[1,0,0,0,1,0,0,0,1],this._rotateOrigin=new $i_5(0,0,0),this._scaleOrigin=new $i_5(0,0,0)};$i_8.prototype={matrix:null,transformCoord:function(t){var e=t.x,i=t.y,n=this.matrix;return t.x=e*n[0]+i*n[1]+n[2],t.y=e*n[3]+i*n[4]+n[5],t},transformCoordInverse:function(t){var e=t.x,i=t.y,n=this.matrix;return t.x=e*n[0]+i*n[1]-n[2],t.y=e*n[3]+i*n[4]-n[5],t},transform:function(t){var e,i=t.length;for(e=0;i>e;e++)this.transformCoord(t[e]);return t},_newRotate:function(t){var e=new $i_8;return e.rotateTo(t),e},rotateBy:function(t){var e=new $i_8;return e.translateBy(this._rotateOrigin.x,this._rotateOrigin.y),e.rotateTo(t),e.translateBy(-this._rotateOrigin.x,-this._rotateOrigin.y),this.multiply(e),this},rotateTo:function(t){var e=this.matrix,i=Math.cos(t),n=Math.sin(t);return e[0]=i,e[1]=-n,e[3]=n,e[4]=i,this},_newScale:function(t,e){var i=new $i_8;return i.matrix[0]=t,i.matrix[4]=e,i},scaleBy:function(t,e){var i=new $i_8;return i.matrix[0]=t,i.matrix[4]=e,this.multiply(i),this},scaleTo:function(t,e){return this.matrix[0]=t,this.matrix[4]=e,this},_newTranslate:function(t,e){var i=new $i_8;return i.matrix[2]=t,i.matrix[5]=e,i},translateBy:function(t,e){var i=new $i_8;return i.matrix[2]=t,i.matrix[5]=e,this.multiply(i),this},translateTo:function(t,e){return this.matrix[2]=t,this.matrix[5]=e,this},copy:function(t){t=t.matrix;var e=this.matrix;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},identity:function(){var t=this.matrix;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},multiply:function(t){var e=this.matrix,i=t.matrix,n=e[0],s=e[1],o=e[2],r=e[3],a=e[4],h=e[5],u=e[6],l=e[7],c=e[8],d=i[0],p=i[1],_=i[2],y=i[3],f=i[4],g=i[5],m=i[6],v=i[7],x=i[8];return e[0]=n*d+s*y+o*m,e[1]=n*p+s*f+o*v,e[2]=n*_+s*g+o*x,e[3]=r*d+a*y+h*m,e[4]=r*p+a*f+h*v,e[5]=r*_+a*g+h*x,e[6]=u*d+l*y+c*m,e[7]=u*p+l*f+c*v,e[8]=u*_+l*g+c*x,this},premultiply:function(t){var e=t.matrix[0]*this.matrix[0]+t.matrix[1]*this.matrix[3]+t.matrix[2]*this.matrix[6],i=t.matrix[0]*this.matrix[1]+t.matrix[1]*this.matrix[4]+t.matrix[2]*this.matrix[7],n=t.matrix[0]*this.matrix[2]+t.matrix[1]*this.matrix[5]+t.matrix[2]*this.matrix[8],s=t.matrix[3]*this.matrix[0]+t.matrix[4]*this.matrix[3]+t.matrix[5]*this.matrix[6],o=t.matrix[3]*this.matrix[1]+t.matrix[4]*this.matrix[4]+t.matrix[5]*this.matrix[7],r=t.matrix[3]*this.matrix[2]+t.matrix[4]*this.matrix[5]+t.matrix[5]*this.matrix[8],a=t.matrix[6]*this.matrix[0]+t.matrix[7]*this.matrix[3]+t.matrix[8]*this.matrix[6],h=t.matrix[6]*this.matrix[1]+t.matrix[7]*this.matrix[4]+t.matrix[8]*this.matrix[7],u=t.matrix[6]*this.matrix[2]+t.matrix[7]*this.matrix[5]+t.matrix[8]*this.matrix[8];return this.matrix[0]=e,this.matrix[1]=i,this.matrix[2]=n,this.matrix[3]=s,this.matrix[4]=o,this.matrix[5]=r,this.matrix[6]=a,this.matrix[7]=h,this.matrix[8]=u,this},getInverse:function(){var t=this.matrix,e=t[0],i=t[1],n=t[2],s=t[3],o=t[4],r=t[5],a=t[6],h=t[7],u=t[8],l=new $i_8,c=e*(o*u-h*r)-s*(i*u-h*n)+a*(i*r-o*n);if(c===0)return null;var d=l.matrix;return d[0]=o*u-r*h,d[1]=n*h-i*u,d[2]=i*r-n*o,d[3]=r*a-s*u,d[4]=e*u-n*a,d[5]=n*s-e*r,d[6]=s*h-o*a,d[7]=i*a-e*h,d[8]=e*o-i*s,l.multiplyScalar(1/c),l},multiplyScalar:function(t){var e;for(e=0;9>e;e++)this.matrix[e]*=t;return this},transformRenderingContextSet:function(t){var e=this.matrix;return t.setTransform(e[0],e[3],e[1],e[4],e[2],e[5]),this},transformRenderingContext:function(t){var e=this.matrix;return t.transform(e[0],e[3],e[1],e[4],e[2],e[5]),this}},typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_8);var $i_11=$i_2.extend({classId:"$i_11",componentId:"velocity",init:function(t){this._entity=t,this._velocity=new $i_5(0,0,0),this._friction=new $i_5(1,1,1),t.addBehaviour("velocity",this._behaviour)},_behaviour:function(t){this.velocity.tick(t)},byAngleAndPower:function(t,e,i){var n=this._velocity,s=Math.cos(t)*e,o=Math.sin(t)*e,r=0;return i?(n.x+=s,n.y+=o,n.z+=r):(n.x=s,n.y=o,n.z=r),this._entity},xyz:function(t,e,i,n){var s=this._velocity;return n?(s.x+=t,s.y+=e,s.z+=i):(s.x=t,s.y=e,s.z=i),this._entity},x:function(t,e){var i=this._velocity;return e?i.x+=t:i.x=t,this._entity},y:function(t,e){var i=this._velocity;return e?i.y+=t:i.y=t,this._entity},z:function(t,e){var i=this._velocity;return e?i.z+=t:i.z=y,this._entity},vector3:function(t,e){typeof t.scale!="number"&&(t.scale=1);var i=this._velocity,n=t.x,s=t.y,o=t.z;return e?(i.x+=n,i.y+=s,i.z+=o):(i.x=n,i.y=s,i.z=o),this._entity},friction:function(t){var e=1-t;return 0>e&&(e=0),this._friction=new $i_5(e,e,e),this._entity},linearForce:function(t,e){e/=1e3;var i=t*Math.PI/180,n=Math.cos(i)*e,s=Math.sin(i)*e,o=n*s;return this._linearForce=new $i_5(n,s,o),this._entity},linearForceXYZ:function(t,e,i){return this._linearForce=new $i_5(t,e,i),this._entity},linearForceVector3:function(t,e,i){var n=this._linearForce=this._linearForce||new $i_5(0,0,0),s=t.x/1e3,o=t.y/1e3,r=t.z/1e3;return i?(n.x+=s||0,n.y+=o||0,n.z+=r||0):(n.x=s||0,n.y=o||0,n.z=r||0),this._entity},_applyLinearForce:function(t){if(this._linearForce){var e=this._velocity;e.x+=this._linearForce.x*t,e.y+=this._linearForce.y*t,e.z+=this._linearForce.z*t}},_applyFriction:function(){var t=this._velocity,e=this._friction;t.x*=e.x,t.y*=e.y,t.z*=e.z},tick:function(){var t,e,i,n=ige.tickDelta,s=this._velocity;n&&(this._applyLinearForce(n),t=s.x*n,e=s.y*n,i=s.z*n,(t||e||i)&&this._entity.translateBy(t,e,i))}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_11);var $i_12=$i_2.extend({classId:"$i_12",componentId:"tween",init:function(t){this._entity=t,this._transform=t.transform,this._tweens=[],t.addBehaviour("tween",this._behaviour)},_behaviour:function(t){this.tween.tick(t)},start:function(t){var e,i=t._targetObj,n=t._propertyObj,s=[];if(i){t._startTime===void 0&&(t._startTime=(new Date).getTime()),t._durationMs===void 0&&(t._durationMs=0),t._endTime=t._startTime+t._durationMs;for(e in n)n.hasOwnProperty(e)&&s.push({targetObj:i,propName:e,startVal:i[e],endVal:n[e],deltaVal:n[e]-i[e]});return t._targetData=s,t._destTime=t._endTime-t._startTime,this._tweens.push(t),this.enable(),t}return this.log('Cannot start tweening properties of the specified object "'+obj+'" because it does not exist!',"error"),-1},stop:function(t){return this._tweens.pull(t),this._tweens.length||this.disable(),this},stopAll:function(){return this.disable(),delete this._tweens,this._tweens=[],this},enable:function(){return this._tweening||(this._tweening=!0),this},disable:function(){return this._tweening&&(this._tweening=!1),this},tick:function(){if(this._tweens&&this._tweens.length){var t,e,i,n,s,o,r,a=ige.tickStart,h=this._tweens,u=h.length;while(u--)if(t=h[u],t._started||a>=t._startTime)if(t._started||(typeof t._beforeTween=="function"&&(t._beforeTween(t),delete t._beforeTween),t._started=!0),e=a-t._startTime,i=t._destTime,n=t._easing,i>e){o=t._targetData;for(r in o)o.hasOwnProperty(r)&&(s=o[r],s.targetObj[s.propName]=this.easing[n](e,s.startVal,s.deltaVal,i))}else{o=t._targetData;for(r in o)o.hasOwnProperty(r)&&(s=o[r],s.targetObj[s.propName]=s.endVal);t.stop(),typeof t._afterTween=="function"&&(t._afterTween(t),delete t._afterTween)}}},easing:{none:function(t,e,i,n){return i*t/n+e},inQuad:function(t,e,i,n){return i*(t/=n)*t+e},outQuad:function(t,e,i,n){return-i*(t/=n)*(t-2)+e},inOutQuad:function(t,e,i,n){return 1>(t/=n/2)?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},inCubic:function(t,e,i,n){return i*(t/=n)*t*t+e},outCubic:function(t,e,i,n){return i*((t=t/n-1)*t*t+1)+e},inOutCubic:function(t,e,i,n){return 1>(t/=n/2)?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e},outInCubic:function(t,e,i,n){return n/2>t?this.outCubic(t*2,e,i/2,n):this.inCubic(t*2-n,e+i/2,i/2,n)},inQuart:function(t,e,i,n){return i*(t/=n)*t*t*t+e},outQuart:function(t,e,i,n){return-i*((t=t/n-1)*t*t*t-1)+e},inOutQuart:function(t,e,i,n){return 1>(t/=n/2)?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},outInQuart:function(t,e,i,n){return n/2>t?this.outQuart(t*2,e,i/2,n):this.inQuart(t*2-n,e+i/2,i/2,n)},inQuint:function(t,e,i,n){return i*(t/=n)*t*t*t*t+e},outQuint:function(t,e,i,n){return i*((t=t/n-1)*t*t*t*t+1)+e},inOutQuint:function(t,e,i,n){return 1>(t/=n/2)?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e},outInQuint:function(t,e,i,n){return n/2>t?this.outQuint(t*2,e,i/2,n):this.inQuint(t*2-n,e+i/2,i/2,n)},inSine:function(t,e,i,n){return-i*Math.cos(t/n*(Math.PI/2))+i+e},outSine:function(t,e,i,n){return i*Math.sin(t/n*(Math.PI/2))+e},inOutSine:function(t,e,i,n){return-i/2*(Math.cos(Math.PI*t/n)-1)+e},outInSine:function(t,e,i,n){return n/2>t?this.outSine(t*2,e,i/2,n):this.inSine(t*2-n,e+i/2,i/2,n)},inExpo:function(t,e,i,n){return t===0?e:i*Math.pow(2,10*(t/n-1))+e-i*.001},outExpo:function(t,e,i,n){return t===n?e+i:i*1.001*(-Math.pow(2,-10*t/n)+1)+e},inOutExpo:function(t,e,i,n){return t===0?e:t===n?e+i:1>(t/=n/2)?i/2*Math.pow(2,10*(t-1))+e-i*5e-4:i/2*1.0005*(-Math.pow(2,-10*--t)+2)+e},outInExpo:function(t,e,i,n){return n/2>t?this.outExpo(t*2,e,i/2,n):this.inExpo(t*2-n,e+i/2,i/2,n)},inCirc:function(t,e,i,n){return-i*(Math.sqrt(1-(t/=n)*t)-1)+e},outCirc:function(t,e,i,n){return i*Math.sqrt(1-(t=t/n-1)*t)+e},inOutCirc:function(t,e,i,n){return 1>(t/=n/2)?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e},outInCirc:function(t,e,i,n){return n/2>t?this.outCirc(t*2,e,i/2,n):this.inCirc(t*2-n,e+i/2,i/2,n)},inElastic:function(t,e,i,n,s,o){var r;return t===0?e:(t/=n)===1?e+i:(o||(o=n*.3),!s||Math.abs(i)>s?(s=i,r=o/4):r=o/(2*Math.PI)*Math.asin(i/s),-(s*Math.pow(2,10*(t-=1))*Math.sin((t*n-r)*2*Math.PI/o))+e)},outElastic:function(t,e,i,n,s,o){var r;return t===0?e:(t/=n)===1?e+i:(o||(o=n*.3),!s||Math.abs(i)>s?(s=i,r=o/4):r=o/(2*Math.PI)*Math.asin(i/s),s*Math.pow(2,-10*t)*Math.sin((t*n-r)*2*Math.PI/o)+i+e)},inOutElastic:function(t,e,i,n,s,o){var r;return t===0?e:(t/=n/2)===2?e+i:(o||(o=n*.3*1.5),!s||Math.abs(i)>s?(s=i,r=o/4):r=o/(2*Math.PI)*Math.asin(i/s),1>t?-.5*s*Math.pow(2,10*(t-=1))*Math.sin((t*n-r)*2*Math.PI/o)+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*n-r)*2*Math.PI/o)*.5+i+e)},outInElastic:function(t,e,i,n,s,o){return n/2>t?this.outElastic(t*2,e,i/2,n,s,o):this.inElastic(t*2-n,e+i/2,i/2,n,s,o)},inBack:function(t,e,i,n,s){return s===void 0&&(s=1.70158),i*(t/=n)*t*((s+1)*t-s)+e},outBack:function(t,e,i,n,s){return s===void 0&&(s=1.70158),i*((t=t/n-1)*t*((s+1)*t+s)+1)+e},inOutBack:function(t,e,i,n,s){return s===void 0&&(s=1.70158),1>(t/=n/2)?i/2*t*t*(((s*=1.525)+1)*t-s)+e:i/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+e},outInBack:function(t,e,i,n,s){return n/2>t?this.outBack(t*2,e,i/2,n,s):this.inBack(t*2-n,e+i/2,i/2,n,s)},inBounce:function(t,e,i,n){return i-this.outBounce(n-t,0,i,n)+e},outBounce:function(t,e,i,n){return 1/2.75>(t/=n)?i*7.5625*t*t+e:2/2.75>t?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:2.5/2.75>t?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},inOutBounce:function(t,e,i,n){return n/2>t?this.inBounce(t*2,0,i,n)*.5+e:this.outBounce(t*2-n,0,i,n)*.5+i*.5+e},outInBounce:function(t,e,i,n){return n/2>t?this.outBounce(t*2,e,i/2,n):this.inBounce(t*2-n,e+i/2,i/2,n)}}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_12);var $i_14=$i_3.extend({classId:"$i_14",componentId:"input",init:function(){this._eventQueue=[],this._eventControl={_cancelled:!1,stopPropagation:function(){this._cancelled=!0}},this.tick(),this.mouse={dblClick:-302,down:-301,up:-300,move:-259,wheel:-258,wheelUp:-257,wheelDown:-256,x:-255,y:-254,button1:-253,button2:-252,button3:-251},this.pad1={button1:-250,button2:-249,button3:-248,button4:-247,button5:-246,button6:-245,button7:-244,button8:-243,button9:-242,button10:-241,button11:-240,button12:-239,button13:-238,button14:-237,button15:-236,button16:-235,button17:-234,button18:-233,button19:-232,button20:-231,stick1:-230,stick2:-229,stick1Up:-228,stick1Down:-227,stick1Left:-226,stick1Right:-225,stick2Up:-224,stick2Down:-223,stick2Left:-222,stick2Right:-221},this.pad2={button1:-220,button2:-219,button3:-218,button4:-217,button5:-216,button6:-215,button7:-214,button8:-213,button9:-212,button10:-211,button11:-210,button12:-209,button13:-208,button14:-207,button15:-206,button16:-205,button17:-204,button18:-203,button19:-202,button20:-201,stick1:-200,stick2:-199,stick1Up:-198,stick1Down:-197,stick1Left:-196,stick1Right:-195,stick2Up:-194,stick2Down:-193,stick2Left:-192,stick2Right:-191},this.key={shift:-3,ctrl:-2,alt:-1,backspace:8,tab:9,enter:13,escape:27,space:32,pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,del:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},this._controlMap=[],this._state=[],this._state[this.mouse.x]=0,this._state[this.mouse.y]=0},debug:function(t){return t!==void 0?(this._debug=t,this):this._debug},_rationalise:function(t,e){if(t.igeType==="key"&&t.keyCode===8){var i=t.srcElement||t.target;i.tagName.toLowerCase()==="body"&&t.preventDefault()}t.igeType==="touch"&&t.preventDefault(),e?(t.button=0,t.changedTouches&&t.changedTouches.length&&(t.igePageX=t.changedTouches[0].pageX,t.igePageY=t.changedTouches[0].pageY)):(t.igePageX=t.pageX,t.igePageY=t.pageY),t.igeX=t.igePageX-this._canvas.offsetLeft,t.igeY=t.igePageY-this._canvas.offsetTop},setupListeners:function(t){this.log("Setting up input event listeners..."),this._canvas=t;var e=this;this._evRef={mousedown:function(t){t.igeType="mouse",e._rationalise(t),e._mouseDown(t)},mouseup:function(t){t.igeType="mouse",e._rationalise(t),e._mouseUp(t)},mousemove:function(t){t.igeType="mouse",e._rationalise(t),e._mouseMove(t)},mousewheel:function(t){t.igeType="mouse",e._rationalise(t),e._mouseWheel(t)},touchmove:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseMove(t)},touchstart:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseDown(t)},touchend:function(t){t.igeType="touch",e._rationalise(t,!0),e._mouseUp(t)},contextmenu:function(t){t.preventDefault()},keydown:function(t){t.igeType="key",e._rationalise(t),e._keyDown(t)},keyup:function(t){t.igeType="key",e._rationalise(t),e._keyUp(t)}},t.addEventListener("mousedown",this._evRef.mousedown,!1),t.addEventListener("mouseup",this._evRef.mouseup,!1),t.addEventListener("mousemove",this._evRef.mousemove,!1),t.addEventListener("mousewheel",this._evRef.mousewheel,!1),t.addEventListener("touchmove",this._evRef.touchmove,!1),t.addEventListener("touchstart",this._evRef.touchstart,!1),t.addEventListener("touchend",this._evRef.touchend,!1),t.addEventListener("contextmenu",this._evRef.contextmenu,!1),window.addEventListener("keydown",this._evRef.keydown,!1),window.addEventListener("keyup",this._evRef.keyup,!1)},destroyListeners:function(){this.log("Removing input event listeners...");var t=this._canvas;t.removeEventListener("mousedown",this._evRef.mousedown,!1),t.removeEventListener("mouseup",this._evRef.mouseup,!1),t.removeEventListener("mousemove",this._evRef.mousemove,!1),t.removeEventListener("mousewheel",this._evRef.mousewheel,!1),t.removeEventListener("touchmove",this._evRef.touchmove,!1),t.removeEventListener("touchstart",this._evRef.touchstart,!1),t.removeEventListener("touchend",this._evRef.touchend,!1),t.removeEventListener("contextmenu",this._evRef.contextmenu,!1),window.removeEventListener("keydown",this._evRef.keydown,!1),window.removeEventListener("keyup",this._evRef.keyup,!1)
},_mouseDown:function(t){this._debug&&console.log("Mouse Down",t),this._updateMouseData(t);var e=t.igeX-ige.geometry.x2,i=t.igeY-ige.geometry.y2,n=this;t.igeBaseX=e,t.igeBaseY=i,t.button===0&&(this._state[this.mouse.button1]=!0),t.button===1&&(this._state[this.mouse.button2]=!0),t.button===2&&(this._state[this.mouse.button3]=!0),this.mouseDown=t,this.queueEvent(this,function(){n.emit("mouseDown",[t,e,i,t.button+1])})},_mouseUp:function(t){this._debug&&console.log("Mouse Up",t),this._updateMouseData(t);var e=t.igeX-ige.geometry.x2,i=t.igeY-ige.geometry.y2,n=this;t.igeBaseX=e,t.igeBaseY=i,t.button===0&&(this._state[this.mouse.button1]=!1),t.button===1&&(this._state[this.mouse.button2]=!1),t.button===2&&(this._state[this.mouse.button3]=!1),this.mouseUp=t,this.queueEvent(this,function(){n.emit("mouseUp",[t,e,i,t.button+1])})},_mouseMove:function(t){ige._mouseOverVp=this._updateMouseData(t);var e=t.igeX-ige.geometry.x2,i=t.igeY-ige.geometry.y2,n=this;t.igeBaseX=e,t.igeBaseY=i,this._state[this.mouse.x]=e,this._state[this.mouse.y]=i,this.mouseMove=t,this.queueEvent(this,function(){n.emit("mouseMove",[t,e,i,t.button+1])})},_mouseWheel:function(t){this._updateMouseData(t);var e=t.igeX-ige.geometry.x2,i=t.igeY-ige.geometry.y2,n=this;t.igeBaseX=e,t.igeBaseY=i,this._state[this.mouse.wheel]=t.wheelDelta,t.wheelDelta>0?this._state[this.mouse.wheelUp]=!0:this._state[this.mouse.wheelDown]=!0,this.mouseWheel=t,this.queueEvent(this,function(){n.emit("mouseWheel",[t,e,i,t.button+1])})},_keyDown:function(t){var e=this;this._state[t.keyCode]=!0,this.queueEvent(this,function(){e.emit("keyDown",[t,t.keyCode])})},_keyUp:function(t){var e=this;this._state[t.keyCode]=!1,this.queueEvent(this,function(){e.emit("keyUp",[t,t.keyCode])})},_updateMouseData:function(t){var e,i,n=ige._children,s=n.length,o=t.igeX-ige.geometry.x/2,r=t.igeY-ige.geometry.y/2;ige._mousePos.x=o,ige._mousePos.y=r;while(s--)if(e=n[n.length-(s+1)],o>e._translate.x-e.geometry.x/2&&e._translate.x+e.geometry.x/2>o&&r>e._translate.y-e.geometry.y/2&&e._translate.y+e.geometry.y/2>r){e._mousePos=new $i_5(Math.floor((o-e._translate.x)/e.camera._scale.x+e.camera._translate.x),Math.floor((r-e._translate.y)/e.camera._scale.y+e.camera._translate.y),0),i=e;break}return i},mapAction:function(t,e){this._controlMap[t]=e},actionVal:function(t){return this._state[this._controlMap[t]]},actionState:function(t){var e=this._state[this._controlMap[t]];return!!e},val:function(t){return this._state[t]},state:function(t){return!!this._state[t]},stopPropagation:function(){return this._eventControl._cancelled=!0,this},queueEvent:function(t,e){return e!==void 0&&this._eventQueue.push([t,e]),this},tick:function(){var t=this._eventQueue,e=t.length,i=this._eventControl;while(e--)if(t[e][1].apply(t[e][0],[i]),i._cancelled)break;this._eventQueue=[],this._eventControl._cancelled=!1,this.dblClick=!1,this.mouseMove=!1,this.mouseDown=!1,this.mouseUp=!1,this.mouseWheel=!1},emit:function(t,e){if(this._eventListeners&&this._eventListeners[t]){var i,n,s,o,r,a,h=this._eventListeners[t].length,u=this._eventListeners[t].length-1,l=this._eventControl;if(h){if(i=[],typeof e=="object"&&e!==null&&e[0]!==null)for(n in e)e.hasOwnProperty(n)&&(i[n]=e[n]);else i=[e];s=!1,this._eventListeners._processing=!0;while(h--){if(l._cancelled)break;o=u-h,r=this._eventListeners[t][o],r.sendEventName&&(i=[t]),a=r.call.apply(r.context||this,i),(a===!0||this._eventControl._cancelled===!0)&&(s=!0),r.oneShot&&this.off(t,r)}if(this._eventListeners._processing=!1,this._processRemovals(),s)return 1}}}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_14),function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Broadphase=function(){this.world=null},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw"collisionPairs not implemented for this BroadPhase class!"},t.NaiveBroadphase=function(){this.temp={r:new t.Vec3,normal:new t.Vec3,quat:new t.Quaternion}},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(e){var i=[],n=[],s=e.numObjects(),o=e.bodies,r=t.Shape.types,a=r.SPHERE|r.BOX|r.COMPOUND|r.CONVEXPOLYHEDRON,h=r.PLANE,u=t.Body.STATIC|t.Body.KINEMATIC,l=this.temp.r,c=this.temp.normal;this.temp.quat;for(var d=0;s>d;d++)for(var p=0;d>p;p++){var _=o[d],y=o[p];if(_.shape&&y.shape){var f=_.shape.type,g=y.shape.type;if(((_.motionstate&u)!==0||_.isSleeping())&&((y.motionstate&u)!==0||y.isSleeping()))continue;if(f&a&&g&a){y.position.vsub(_.position,l);var m=_.shape.boundingSphereRadius()+y.shape.boundingSphereRadius();m*m>l.norm2()&&(i.push(_),n.push(y))}else if(f&a&&g&r.PLANE||g&a&&f&r.PLANE){var v=f===h?d:p,x=f!==h?d:p;o[x].position.vsub(o[v].position,l),o[v].quaternion.vmult(o[v].shape.normal,c);var w=l.dot(c)-o[x].shape.boundingSphereRadius();0>w&&(i.push(_),n.push(y))}}}return[i,n]},t.Ray=function(e,i){function n(t,e,i){return i.vsub(t,x),l=x.dot(e),e.mult(l,w),w.vadd(t,w),c=i.distanceTo(w)}function s(t,e,i,n){return n.vsub(e,x),i.vsub(e,b),t.vsub(e,z),d=x.dot(x),p=x.dot(b),_=x.dot(z),y=b.dot(b),f=b.dot(z),g=1/(d*y-p*p),m=(y*_-p*f)*g,v=(d*f-p*_)*g,m>=0&&v>=0&&1>m+v}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var o=1e-4;this.setPrecision=function(t){o=t};var r=new t.Vec3,a=new t.Vec3,h=new t.Vec3;new t.Vec3,new t.Vec3,new t.Vec3,new t.Vec3;var u=new t.Vec3;this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):(console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes."),void 0)},this.intersectShape=function(e,i,l,c){var d,p=[];if(e instanceof t.ConvexPolyhedron){var _=n(this.origin,this.direction,l);if(_>e.boundingSphereRadius())return p;var y,f,g=e.faces,m=e.vertices,v=e.faceNormals;for(fi=0;g.length>fi;fi++){var x=g[fi],w=v[fi],b=i,z=l,M=new t.Vec3;m[x[0]].copy(M),M.vsub(this.origin,M),b.vmult(M,M),M.vadd(z,M);var I=new t.Vec3;if(b.vmult(w,I),y=this.direction.dot(I),Math.abs(y)>=o&&(f=I.dot(M)/y,f>=0&&0>y)){this.direction.mult(f,u),u.vadd(this.origin,u),m[x[0]].copy(r),b.vmult(r,r),z.vadd(r,r);for(var T=1;x.length-1>T;T++)if(m[x[T]].copy(a),m[x[T+1]].copy(h),b.vmult(a,a),b.vmult(h,h),z.vadd(a,a),z.vadd(h,h),s(u,r,a,h)){d={distance:this.origin.distanceTo(u),point:u.copy(),face:x,body:c},p.push(d);break}}}}return p},this.intersectBodies=function(t){for(var e=[],i=0,n=t.length;n>i;i++){var s=this.intersectBody(t[i]);Array.prototype.push.apply(e,s)}return e.sort(function(t,e){return t.distance-e.distance}),e};var l,c,d,p,_,y,f,g,m,v,x=new t.Vec3,w=new t.Vec3,b=new t.Vec3,z=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Mat3=function(t){this.elements=t?new Float32Array(t):new Float32Array(9)},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.vmult=function(e,i){i===void 0&&(i=new t.Vec3);for(var n=[e.x,e.y,e.z],s=[0,0,0],o=0;3>o;o++)for(var r=0;3>r;r++)s[o]+=this.elements[o+3*r]*n[o];return i.x=s[0],i.y=s[1],i.z=s[2],i},t.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,n=0;3>n;n++)for(var s=0;3>s;s++){for(var o=0,r=0;3>r;r++)o+=this.elements[n+r]*e.elements[r+s*3];i.elements[n+s*3]=o}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;var n,s,o=3,r=4,a=new Float32Array(o*r);for(n=0;3>n;n++)for(s=0;3>s;s++)a[n+r*s]=this.elements[n+3*s];a[3]=e.x,a[7]=e.y,a[11]=e.z;var h,u,l,c=3,d=c,p=4;do{if(n=d-c,a[n+r*n]===0)for(s=n+1;d>s;s++)if(a[n+r*s]!==0){l=[],h=p;do u=p-h,l.push(a[u+r*n]+a[u+r*s]);while(--h);a[n+r*0]=l[0],a[n+r*1]=l[1],a[n+r*2]=l[2];break}if(a[n+r*n]!==0)for(s=n+1;d>s;s++){var _=a[n+r*s]/a[n+r*n];l=[],h=p;do u=p-h,l.push(u>n?a[u+r*s]-a[u+r*n]*_:0);while(--h);a[s+r*0]=l[0],a[s+r*1]=l[1],a[s+r*2]=l[2]}}while(--c);if(i.z=a[2*r+3]/a[2*r+2],i.y=(a[1*r+3]-a[1*r+2]*i.z)/a[1*r+1],i.x=(a[0*r+3]-a[0*r+2]*i.z-a[0*r+1]*i.y)/a[0*r+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||i.x===1/0||i.y===1/0||i.z===1/0)throw"Could not solve equation! Got x=["+(i+"")+"], b=["+(e+"")+"], A=["+(this+"")+"]";return i},t.Mat3.prototype.e=function(t,e,i){return i===void 0?this.elements[t+3*e]:(this.elements[t+3*e]=i,void 0)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;this.elements.length>i;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){i=i||new t.Vec3;var n=[this.x,this.y,this.z],s=[e.x,e.y,e.z];return i.x=n[1]*s[2]-n[2]*s[1],i.y=n[2]*s[0]-n[0]*s[2],i.z=n[0]*s[1]-n[1]*s[0],i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return t>0?(this.x/=t,this.y/=t,this.z/=t):(this.x=0,this.y=0,this.z=0),t},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return i>0?(i=1/i,e.x=this.x*i,e.y=this.y*i,e.z=this.z*i):(e.x=0,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)+(t.z-this.z)*(t.z-this.z))},t.Vec3.prototype.mult=function(e,i){return i||(i=new t.Vec3),i.x=e*this.x,i.y=e*this.y,i.z=e*this.z,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e},t.Vec3.prototype.tangents=function(e,i){var n=this.norm();if(n>0){var s=new t.Vec3(this.x/n,this.y/n,this.z/n);if(.9>s.x){var o=Math.random();s.cross(new t.Vec3(o,1e-7,0).unit(),e)}else s.cross(new t.Vec3(1e-7,o,0).unit(),e);s.cross(e,i)}else e.set(1,0,0).normalize(),i.set(0,1,0).normalize()},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){i.x=this.x+(t.x-this.x)*e,i.y=this.y+(t.y-this.y)*e,i.z=this.z+(t.z-this.z)*e},t.Vec3.prototype.almostEquals=function(t,e){return e===void 0&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},t.Vec3.prototype.almostZero=function(t){return t===void 0&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},t.Quaternion=function(t,e,i,n){this.x=t!=void 0?t:0,this.y=e!=void 0?e:0,this.z=i!=void 0?i:0,this.w=n!=void 0?n:1},t.Quaternion.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(e*.5);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(e*.5)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()},t.Quaternion.prototype.mult=function(e,i){i==void 0&&(i=new t.Quaternion);var n=new t.Vec3(this.x,this.y,this.z),s=new t.Vec3(e.x,e.y,e.z);return i.w=this.w*e.w-n.dot(s),vaxvb=n.cross(s),i.x=this.w*s.x+e.w*n.x+vaxvb.x,i.y=this.w*s.y+e.w*n.y+vaxvb.y,i.z=this.w*s.z+e.w*n.z+vaxvb.z,i},t.Quaternion.prototype.inverse=function(e){e==void 0&&(e=new t.Quaternion),this.conjugate(e);var i=1/(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return e.x*=i,e.y*=i,e.z*=i,e.w*=i,e},t.Quaternion.prototype.conjugate=function(e){return e==void 0&&(e=new t.Quaternion),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);t===0?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;t===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,this.w==0)i.x=e.x,i.y=e.y,i.z=e.z;else{var n=e.x,s=e.y,o=e.z,r=this.x,a=this.y,h=this.z,u=this.w,l=u*n+a*o-h*s,c=u*s+h*n-r*o,d=u*o+r*s-a*n,p=-r*n-a*s-h*o;i.x=l*u+p*-r+c*-h-d*-a,i.y=c*u+p*-a+d*-r-l*-h,i.z=d*u+p*-h+l*-a-c*-r}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,s,o=this.x,r=this.y,a=this.z,h=this.w;switch(e){case"YZX":var u=o*r+a*h;if(u>.499&&(i=2*Math.atan2(o,h),n=Math.PI/2,s=0),-.499>u&&(i=-2*Math.atan2(o,h),n=-Math.PI/2,s=0),isNaN(i)){var l=o*o,c=r*r,d=a*a;i=Math.atan2(2*r*h-2*o*a,1-2*c-2*d),n=Math.asin(2*u),s=Math.atan2(2*o*h-2*r*a,1-2*l-2*d)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=s},t.Shape=function(){this.type=0,this.aabbmin=new t.Vec3,this.aabbmax=new t.Vec3},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.boundingSphereRadius=function(){throw"boundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},t.Shape.prototype.calculateTransformedInertia=function(e,i,n){n==void 0&&(n=new t.Vec3),i.normalize();var s=this.calculateLocalInertia(e),o=i.vmult(s);return n.x=Math.abs(o.x),n.y=Math.abs(o.y),n.z=Math.abs(o.z),n},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if(typeof e!="number")throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle");var n=this;this.position=new t.Vec3,this.initPosition=new t.Vec3,this.velocity=new t.Vec3,this.initVelocity=new t.Vec3,this.force=new t.Vec3,this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=e>0?t.Body.DYNAMIC:t.Body.STATIC,this.allowSleep=!0;var s=0;this.isAwake=function(){return s==0},this.isSleepy=function(){return s==1},this.isSleeping=function(){return s==2},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1e3;var o=(new Date).getTime();this.wakeUp=function(){s=0,n.dispatchEvent({type:"wakeup"})},this.sleep=function(){s=2},this.sleepTick=function(){n.allowSleep&&(s==0&&n.sleepSpeedLimit>n.velocity.norm()?(s=1,o=(new Date).getTime(),n.dispatchEvent({type:"sleepy"})):s==1&&n.velocity.norm()>n.sleepSpeedLimit?n.wakeUp():s==1&&(new Date).getTime()-o>n.sleepTimeLimit&&(s=2,n.dispatchEvent({type:"sleep"})))}},t.RigidBody=function(e,i,n){if(typeof e!="number")throw Error("Argument 1 (mass) must be a number.");if(typeof i!="object"||!(i instanceof t.Shape))throw Error("Argument 2 (shape) must be an instance of CANNON.Shape.");if(n!==void 0&&!(n instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,n),this.tau=new t.Vec3,this.quaternion=new t.Quaternion,this.initQuaternion=new t.Quaternion,this.angularVelocity=new t.Vec3,this.initAngularVelocity=new t.Vec3,this.shape=i,this.inertia=new t.Vec3,i.calculateLocalInertia(e,this.inertia),this.invInertia=new t.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.angularDamping=.01},t.Sphere=function(e){t.Shape.call(this),this.radius=e!=void 0?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;var n=2*e*this.radius*this.radius/5;return i.x=n,i.y=n,i.z=n,i},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.boundingSphereRadius=function(){return this.radius},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,s=t.Vec3,o=new t.ConvexPolyhedron([new s(-e,-i,-n),new s(e,-i,-n),new s(e,i,-n),new s(-e,i,-n),new s(-e,-i,n),new s(e,-i,n),new s(e,i,n),new s(-e,i,n)],[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new s(0,0,-1),new s(0,0,1),new s(0,-1,0),new s(0,1,0),new s(-1,0,0),new s(1,0,0)]);this.convexPolyhedronRepresentation=o},t.Box.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3,i.x=1/12*e*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.z*2*this.halfExtents.z),i.y=1/12*e*(2*this.halfExtents.x*2*this.halfExtents.x+2*this.halfExtents.z*2*this.halfExtents.z),i.z=1/12*e*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.x*2*this.halfExtents.x),i},t.Box.prototype.getCorners=function(e){var i=[],n=this.halfExtents;i.push(new t.Vec3(n.x,n.y,n.z)),i.push(new t.Vec3(-n.x,n.y,n.z)),i.push(new t.Vec3(-n.x,-n.y,n.z)),i.push(new t.Vec3(-n.x,-n.y,-n.z)),i.push(new t.Vec3(n.x,-n.y,-n.z)),i.push(new t.Vec3(n.x,n.y,-n.z)),i.push(new t.Vec3(-n.x,n.y,-n.z)),i.push(new t.Vec3(n.x,-n.y,n.z));for(var s=0;e!=void 0&&i.length>s;s++)e.vmult(i[s],i[s]);return i},t.Box.prototype.getSideNormals=function(e,i){var n=[],s=this.halfExtents;n.push(new t.Vec3(s.x,0,0)),n.push(new t.Vec3(0,s.y,0)),n.push(new t.Vec3(0,0,s.z)),e!=void 0&&e&&(n.push(new t.Vec3(-s.x,0,0)),n.push(new t.Vec3(0,-s.y,0)),n.push(new t.Vec3(0,0,-s.z)));for(var o=0;i!=void 0&&n.length>o;o++)i.vmult(n[o],n[o]);return n},t.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},t.Box.prototype.boundingSphereRadius=function(){return this.halfExtents.norm()},t.Plane=function(e){t.Shape.call(this),e.normalize(),this.normal=e,this.type=t.Shape.types.PLANE},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.calculateLocalInertia=function(e,i){return i=i||new t.Vec3},t.Plane.prototype.volume=function(){return 1/0},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(e,i,n){i=i||new t.Vec3,n=n||new t.Quaternion,this.childShapes.push(e),this.childOffsets.push(i),this.childOrientations.push(n)},t.Compound.prototype.volume=function(){for(var t=0,e=0;this.childShapes.length>e;e++)t+=this.childShapes[e].volume();return t},t.Compound.prototype.calculateLocalInertia=function(e,i){i=i||new t.Vec3;for(var n=this.volume(),s=0;this.childShapes.length>s;s++){var o=this.childShapes[s],r=this.childOffsets[s],a=this.childOrientations[s],h=o.volume()/n*e,u=o.calculateTransformedInertia(h,a);i.vadd(u,i);var l=new t.Vec3(h*r.x*r.x,h*r.y*r.y,h*r.z*r.z);i.vadd(l,i)}return i},t.Compound.prototype.boundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childOffsets[e].norm()+this.childShapes[e].boundingSphereRadius();i>t&&(t=i)}return t},t.ConvexPolyhedron=function(e,i,n){function s(e,i,n,s,o){for(var r=e.vertices.length,a=null,h=null,u=e.vertices,l=new t.Vec3,c=0;r>c;c++){u[c].copy(l),s.vmult(l,l),l.vadd(n,l);var d=l.dot(i);(a===null||d>a)&&(a=d),(h===null||h>d)&&(h=d)}if(h>a){var p=h;h=a,a=p}o[0]=a,o[1]=h}function o(t){var e=r.faces[t],i=r.faceNormals[t],n=r.vertices[e[0]],s=-i.dot(n);return s}var r=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON,this.vertices=[],this.faces=i,this.faceNormals=n,this.uniqueEdges=[];for(pi in e){var a=e[pi];if(!(a instanceof t.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.vertices.push(a)}for(var h=0;i.length>h;h++)for(var u=i[h].length,l=u,c=0;l>c;c++){var d=(c+1)%u,p=new t.Vec3;this.vertices[i[h][c]].vsub(this.vertices[i[h][d]],p),p.normalize();for(var _=!1,a=0;this.uniqueEdges.length>a;a++)if(this.uniqueEdges[a].almostEquals(p)||this.uniqueEdges[a].almostEquals(p)){_=!0;break}if(_||this.uniqueEdges.push(p),p)p.face1=h;else{var y;y.m_face0=h,edges.insert(vp,y)}}this.testSepAxis=function(t,e,i,n,o,r){var a=[],h=[],u=this;s(u,t,i,n,a),s(e,t,o,r,h);var l=a[0],c=a[1],d=h[0],p=h[1];if(p>l||c>d)return!1;var _=l-p,y=d-c;return depth=y>_?_:y},this.findSeparatingAxis=function(e,i,n,s,o,r){for(var a=1/0,h=this,u=0,l=h.faces.length,c=new t.Vec3,d=0;l>d;d++){h.faceNormals[d].copy(c),n.vmult(c,c);var p=h.testSepAxis(c,e,i,n,s,o);if(p===!1)return!1;a>p&&(a=p,c.copy(r))}for(var _=new t.Vec3,y=e.faces.length,d=0;y>d;d++){e.faceNormals[d].copy(_),o.vmult(_,_),u++;var p=h.testSepAxis(_,e,i,n,s,o);if(p===!1)return!1;a>p&&(a=p,_.copy(r))}for(var f=0,g=new t.Vec3,m=new t.Vec3,v=new t.Vec3,x=0;h.uniqueEdges.length>x;x++){h.uniqueEdges[x].copy(g),n.vmult(g,g);for(var w=0;e.uniqueEdges.length>w;w++)if(e.uniqueEdges[w].copy(m),o.vmult(m,m),g.cross(m,v),f++,!v.almostZero()){v.normalize();var b=h.testSepAxis(v,e,i,n,s,o);if(b===!1)return!1;a>b&&(a=b,v.copy(r))}}var z=new t.Vec3;return s.vsub(i,z),z.dot(r)>0&&r.negate(r),!0},this.clipAgainstHull=function(e,i,n,s,o,r,a,h,u){if(!(e instanceof t.Vec3))throw Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw Error("quatA must be Quaternion");for(var l=-1,c=-1/0,d=new t.Vec3,p=0;n.faces.length>p;p++){n.faceNormals[p].copy(d),o.vmult(d,d),s.vadd(d,d);var _=d.dot(r);_>c&&(c=_,l=p)}var y=[];polyB=n.faces[l];for(var f=polyB.length,g=0;f>g;g++){var m=n.vertices[polyB[g]],v=new t.Vec3;m.copy(v),o.vmult(v,v),s.vadd(v,v),y.push(v)}0>l||this.clipFaceAgainstHull(r,e,i,y,a,h,u)},this.clipFaceAgainstHull=function(e,i,n,s,r,a,h){if(!(e instanceof t.Vec3))throw Error("sep normal must be vector");if(!(s instanceof Array))throw Error("world verts must be array");r=Number(r),a=Number(a);for(var u=this,l=[],c=s,d=l,p=-1,_=1/0,y=new t.Vec3,f=0;u.faces.length>f;f++){u.faceNormals[f].copy(y),n.vmult(y,y),i.vadd(y,y);var g=y.dot(e);_>g&&(_=g,p=f)}if(0>p)return console.log("--- did not find any closest face... ---"),void 0;var m=u.faces[p];m.connectedFaces=[];for(var v=0;u.faces.length>v;v++)for(var x=0;u.faces[v].length>x;x++)m.indexOf(u.faces[v][x])!==-1&&v!==p&&m.connectedFaces.indexOf(v)===-1&&m.connectedFaces.push(v);c.length;for(var w=m.length,b=new t.Vec3,z=new t.Vec3,M=new t.Vec3,I=new t.Vec3,T=0;w>T;T++){var C=u.vertices[m[T]],S=u.vertices[m[(T+1)%w]];C.vsub(S,b),b.copy(z),n.vmult(z,z),i.vadd(z,z),this.faceNormals[p].copy(M),n.vmult(M,M),i.vadd(M,M),z.cross(M,I),I.negate(I);var P=new t.Vec3;C.copy(P),n.vmult(P,P),i.vadd(P,P);var k,A,E=(-P.dot(I),m.connectedFaces[T]),V=new t.Vec3;this.faceNormals[E].copy(V);var O=o(E),k=new t.Vec3;V.copy(k),n.vmult(k,k);var A=O-k.dot(i);this.clipFaceAgainstPlane(c,d,k,A);while(c.length)c.shift();while(d.length)c.push(d.shift())}var V=new t.Vec3;this.faceNormals[p].copy(V);var O=o(p),k=new t.Vec3;V.copy(k),n.vmult(k,k);for(var A=O-k.dot(i),v=0;c.length>v;v++){var D=k.dot(c[v])+A;if(D>r||(console.log("clamped: depth="+D+" to minDist="+(r+"")),D=r),a>=D){var R=c[v],B={point:R,normal:k,depth:D};h.push(B)}}},this.clipFaceAgainstPlane=function(e,i,n,s){if(!(n instanceof t.Vec3))throw Error("planeNormal must be Vec3, "+n+" given");if(!(e instanceof Array))throw Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw Error("outvertices must be Array, "+i+" given");var o,r,a=e.length;if(2>a)return i;var h=e[e.length-1],u=e[0];o=n.dot(h)+s;for(var l=0;a>l;l++){if(u=e[l],r=n.dot(u)+s,0>o)if(0>r){var c=new t.Vec3;u.copy(c),i.push(c)}else{var c=new t.Vec3;h.lerp(u,o/(o-r),c),i.push(c)}else if(0>r){var c=new t.Vec3;h.lerp(u,o/(o-r),c),i.push(c),i.push(u)}h=u,o=r}return i};var r=this;this.calculateLocalInertia=function(t,e){var i=this.aabbmax.x-this.aabbmin.x,n=this.aabbmax.y-this.aabbmin.y,s=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*n*2*n+2*s*2*s),e.y=1/12*t*(2*i*2*i+2*s*2*s),e.z=1/12*t*(2*n*2*n+2*i*2*i)},this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,n=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var s=0;t>s;s++){var o=n[s];e.x>o.x?e.x=o.x:o.x>i.x&&(i.x=o.x),e.y>o.y?e.y=o.y:o.y>i.y&&(i.y=o.y),e.z>o.z?e.z=o.z:o.z>i.z&&(i.z=o.z)}},this.boundingSphereRadius=function(){for(var t=0,e=0;this.vertices.length>e;e++){var i=this.vertices[e].norm2();i>t&&(t=i)}return Math.sqrt(t)},this.computeAABB()},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.Solver=function(){this.iterations=10,this.h=1/60,this.k=1e3,this.d=4,this.a=0,this.b=0,this.eps=0,this.setSpookParams(this.k,this.d),this.reset(0),this.debug=!1,this.debug&&console.log("a:",this.a,"b",this.b,"eps",this.eps,"k",this.k,"d",this.d)},t.Solver.prototype.setSpookParams=function(t,e){var i=this.h;this.k=t,this.d=e,this.a=4/(i*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(i*i*t*(1+4*e))},t.Solver.prototype.reset=function(t){this.G=[],this.MinvTrace=[],this.Fext=[],this.q=[],this.qdot=[],this.n=0,this.upper=[],this.lower=[],this.hasupper=[],this.haslower=[],this.i=[],this.j=[],this.vxlambda=[],this.vylambda=[],this.vzlambda=[],this.wxlambda=[],this.wylambda=[],this.wzlambda=[];for(var e=0;t>e;e++)this.vxlambda.push(0),this.vylambda.push(0),this.vzlambda.push(0),this.wxlambda.push(0),this.wylambda.push(0),this.wzlambda.push(0)},t.Solver.prototype.addConstraint=function(t,e,i,n,s,o,r,a,h){this.debug&&(console.log("Adding constraint ",this.n," between body ",a," and ",h),console.log("G:",t),console.log("q:",i),console.log("qdot:",n),console.log("Fext:",s),console.log("lower:",o),console.log("upper:",r));for(var u=0;12>u;u++)this.q.push(i[u]),this.qdot.push(n[u]),this.MinvTrace.push(e[u]),this.G.push(t[u]),this.Fext.push(s[u]);return this.upper.push(r),this.hasupper.push(!isNaN(r)),this.lower.push(o),this.haslower.push(!isNaN(o)),this.i.push(a),this.j.push(h),this.n+=1,this.n-1},t.Solver.prototype.addConstraint2=function(t,e,i){t.update();for(var n=0;t.equations.length>n;n++){var s=t.equations[n];this.addConstraint([s.G1.x,s.G1.y,s.G1.z,s.G2.x,s.G2.y,s.G2.z,s.G3.x,s.G3.y,s.G3.z,s.G4.x,s.G4.y,s.G4.z],[s.iM1.x,s.iM1.y,s.iM1.z,s.iM2.x,s.iM2.y,s.iM2.z,s.iM3.x,s.iM3.y,s.iM3.z,s.iM4.x,s.iM4.y,s.iM4.z],[s.g1.x,s.g1.y,s.g1.z,s.g2.x,s.g2.y,s.g2.z,s.g3.x,s.g3.y,s.g3.z,s.g4.x,s.g4.y,s.g4.z],[s.W1.x,s.W1.y,s.W1.z,s.W2.x,s.W2.y,s.W2.z,s.W3.x,s.W3.y,s.W3.z,s.W4.x,s.W4.y,s.W4.z],[s.f1.x,s.f1.y,s.f1.z,s.f2.x,s.f2.y,s.f2.z,s.f3.x,s.f3.y,s.f3.z,s.f4.x,s.f4.y,s.f4.z],s.lambdamin,s.lambdamax,e,i)}},t.Solver.prototype.addNonPenetrationConstraint=function(t,e,i,n,s,o,r,a,h,u,l,c,d,p,_,y,f,g,m){var v=o.cross(s),x=d.vsub(c),w=n.vadd(r).vsub(i.vadd(o)),b=w.dot(s);0>b&&(this.debug&&(console.log("i:",t,"j",e,"xi",i+"","xj",n+""),console.log("ni",s+"","ri",o+"","rj",r+""),console.log("iMi",a+"","iMj",h+"","iIi",u+"","iIj",l+"","vi",c+"","vj",d+"","wi",p+"","wj",_+"","fi",y+"","fj",f+"","taui",g+"","tauj",m+"")),this.addConstraint([-s.x,-s.y,-s.z,-v.x,-v.y,-v.z,s.x,s.y,s.z,v.x,v.y,v.z],[a.x,a.y,a.z,u.z,u.y,u.z,h.x,h.y,h.z,l.z,l.y,l.z],[-w.x,-w.y,-w.z,0,0,0,w.x,w.y,w.z,0,0,0],[-x.x,-x.y,-x.z,0,0,0,x.x,x.y,x.z,0,0,0],[y.x,y.y,y.z,g.x,g.y,g.z,f.x,f.y,f.z,m.x,m.y,m.z],0,"inf",t,e))},t.Solver.prototype.solve=function(){for(var t=this.n,e=[],i=[],n=[],s=[],o=[],r=this.iterations,a=this.G,h=this.debug,u=this.a,l=this.eps,c=this.lower,d=this.haslower,p=this.upper,_=this.hasupper,y=this.vxlambda,f=this.vylambda,g=this.vzlambda,m=this.wxlambda,v=this.wylambda,x=this.wzlambda,w=this.MinvTrace,b=0;t>b;b++){e.push(0),i.push(0),n.push(0),s.push(0),o.push(0);for(var z=0;12>z;z++)i.push(0)}for(var M=0;r>M;M++)for(var I=0;t>I;I++){var T=this.i[I],C=this.j[I],S=12*I;if(!o[I]){for(var P=0,k=0,A=0,E=0,b=0;12>b;b++){var V=S+b;P+=a[V]*w[V]*a[V],k+=a[V]*this.q[V],A+=a[V]*this.qdot[V],E+=a[V]*w[V]*this.Fext[V]}s[I]=1/(P+l),n[I]=-u*k-this.b*A-this.h*E,o[I]=1,h&&(console.log("G_Minv_Gt["+I+"]:",P),console.log("Gq["+I+"]:",k),console.log("GW["+I+"]:",A),console.log("GMinvf["+I+"]:",E))}var O=0;0>T||(O+=a[0+S]*y[T],O+=a[1+S]*f[T],O+=a[2+S]*g[T],O+=a[3+S]*m[T],O+=a[4+S]*v[T],O+=a[5+S]*x[T],h&&isNaN(O)&&console.log("found NaN Gulambda",y)),C!==-1&&(O+=a[6+S]*y[C],O+=a[7+S]*f[C],O+=a[8+S]*g[C],O+=a[9+S]*m[C],O+=a[10+S]*v[C],O+=a[11+S]*x[C]),i[I]=s[I]*(n[I]-O-l*e[I]),h&&console.log("dlambda["+I+"]=",i[I],"rest = ",s[I],n[I],O,l,e[I],I,T,C),e[I]=e[I]+i[I],d[I]&&c[I]>e[I]&&(h&&console.log("hit lower bound for constraint "+I+", truncating "+e[I]+" to the bound "+c[I]),e[I]=c[I],i[I]=c[I]-e[I]),_&&e[I]>p[I]&&(h&&console.log("hit upper bound for constraint "+I+", truncating "+e[I]+" to the bound "+p[I]),e[I]=p[I],i[I]=p[I]-e[I]),T!==-1&&(y[T]+=i[I]*w[S+0]*a[S+0],f[T]+=i[I]*w[S+1]*a[S+1],g[T]+=i[I]*w[S+2]*a[S+2],m[T]+=i[I]*w[S+3]*a[S+3],v[T]+=i[I]*w[S+4]*a[S+4],x[T]+=i[I]*w[S+5]*a[S+5]),C!==-1&&(y[C]+=i[I]*w[S+6]*a[S+6],f[C]+=i[I]*w[S+7]*a[S+7],g[C]+=i[I]*w[S+8]*a[S+8],m[C]+=i[I]*w[S+9]*a[S+9],v[C]+=i[I]*w[S+10]*a[S+10],x[C]+=i[I]*w[S+11]*a[S+11])}if(h)for(var b=0;this.vxlambda.length>b;b++)console.log("dv["+b+"]=",y[b],f[b],g[b],m[b],v[b],x[b])},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){t[e]==void 0&&(t[e]=[]),t[e].indexOf(i)===-1&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var n=t[e].indexOf(i);n!==-1&&t[e].splice(n,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t in arguments)this.objects.push(arguments[t])},t.ObjectPool.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=t.Vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return new t.Vec3},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,n){this.id=-1,this.materials=[t,e],this.friction=i!=void 0?Number(i):.3,this.restitution=n!=void 0?Number(n):.3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new t.Vec3,this.broadphase=null,this.bodies=[],this.solver=new t.Solver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.temp={gvec:new t.Vec3,vi:new t.Vec3,vj:new t.Vec3,wi:new t.Vec3,wj:new t.Vec3,t1:new t.Vec3,t2:new t.Vec3,rixn:new t.Vec3,rjxn:new t.Vec3,step_q:new t.Quaternion,step_w:new t.Quaternion,step_wq:new t.Quaternion}
},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var n=e.id,s=i.id;if(s>n){var o=n;n=s,s=o}return this.contactmaterials[this.mats2cmat[n+s*this.materials.length]]}},t.World.prototype._addImpulse=function(e,i,n,s,o,r,a,h){var u=n.crossmat(),l=s.crossmat(),c=this.inertiax[e]>0?1/this.inertiax[e]:0,d=new t.Mat3([c,0,0,0,c,0,0,0,c]);c=this.inertiax[i]>0?1/this.inertiax[i]:0;var p=new t.Mat3([c,0,0,0,c,0,0,0,c]),_=this.invm[e]+this.invm[i],y=new t.Mat3([_,0,0,0,_,0,0,0,_]);u.mmult(d.mmult(u)),l.mmult(p.mmult(l));var f=r.mult(-a*o.dot(r)),g=y.solve(f.vsub(o)),h=0;if(h>0){var m=r.mult(g.dot(r)),v=g.vsub(m);if(v.norm()>m.mult(h).norm()){var x=o.vsub(r.mult(o.dot(r))),w=x.mult(1/(x.norm()+1e-4)),b=-(1+a)*o.dot(r)/r.dot(y.vmult(r.vsub(w.mult(h))));g=r.mult(b).vsub(w.mult(h*b))}}var z=this.invm[e],M=this.invm[i];this.vx[e]+=g.x*z-(this.vx[i]-o.x),this.vy[e]+=g.y*z-(this.vy[i]-o.y),this.vz[e]+=g.z*z-(this.vz[i]-o.z),this.vx[i]-=g.x*M+(this.vx[e]+o.x),this.vy[i]-=g.y*M+(this.vy[e]+o.y),this.vz[i]-=g.z*M+(this.vz[e]+o.z);var I=n.cross(g);I.mult(1/this.inertiax[e])},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.clearCollisionState=function(t){for(var e=this.numObjects(),i=t.id,n=0;e>n;n++){var s=n;i>s?this.collision_matrix[s+i*e]=0:this.collision_matrix[i+s*e]=0}},t.World.prototype.add=function(e){var i=this.numObjects();this.bodies.push(e),e.id=this.id(),e.world=this,e.position.copy(e.initPosition),e.velocity.copy(e.initVelocity),e instanceof t.RigidBody&&(e.angularVelocity.copy(e.initAngularVelocity),e.quaternion.copy(e.initQuaternion)),this.collision_matrix=new Int16Array((i+1)*(i+1))},t.World.prototype.addConstraint=function(e){e instanceof t.Constraint&&(this.constraints.push(e),e.id=this.id())},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects(),i=this.bodies;for(var n in i)i[n].id==t.id&&i.splice(n,1);this.collision_matrix=new Int16Array((e-1)*(e-1))},t.World.prototype.addMaterial=function(t){if(t.id==-1){this.materials.push(t),t.id=this.materials.length-1;for(var e=new Int16Array(this.materials.length*this.materials.length),i=0;e.length>i;i++)e[i]=-1;for(var i=0;this.materials.length-1>i;i++)for(var n=0;this.materials.length-1>n;n++)e[i+this.materials.length*n]=this.mats2cmat[i+(this.materials.length-1)*n];this.mats2cmat=e}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]),t.materials[0].id>t.materials[1].id?(i=t.materials[0].id,j=t.materials[1].id):(j=t.materials[0].id,i=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=t.id},t.World.prototype._id2index=function(t){for(var e=0;this.bodies.length>e;e++)if(this.bodies[e].id===t)return e;return-1},t.World.prototype.step=function(e){function i(t,e,i){if(i===void 0&&(i=!0),i&&e>t||!i&&t>e){var n=e;e=t,t=n}return r.collision_matrix[t+e*a]}function n(t,e,i,n){if(n===void 0&&(n=!0),n&&e>t||!n&&t>e){var s=e;e=t,t=s}r.collision_matrix[t+e*a]=parseInt(i)}function s(){for(var t=0;h.length>t;t++)for(var e=0;t>e;e++){var s=i(t,e,!0);n(t,e,s,!1),n(t,e,0,!0)}}var o=this,r=this,a=this.numObjects(),h=this.bodies;e==void 0&&(e=this.last_dt?this.last_dt:this.default_dt);for(var u=0;a>u;u++){var l=h[u];if(l.motionstate&t.Body.DYNAMIC){var c=h[u].force,d=h[u].mass;c.x+=o.gravity.x*d,c.y+=o.gravity.y*d,c.z+=o.gravity.z*d}}var p=this.broadphase.collisionPairs(this),_=p[0],y=p[1];t.Shape.types.SPHERE,t.Shape.types.PLANE,t.Shape.types.BOX,t.Shape.types.COMPOUND,s(),this.solver.reset(a);var f=this.contacts;this.contacts=[],this.contactgen.getContacts(_,y,this,this.contacts,f);for(var g=this.temp,m=0;this.contacts.length>m;m++){var v=this.contacts[m],l=v.bi,x=v.bj,u=this._id2index(l.id),w=this._id2index(x.id);i(u,w,!1);var b=.3,z=.2,M=this.getContactMaterial(l.material,x.material);M&&(b=M.friction,z=M.restitution);var I=g.gvec;I.set(x.position.x+v.rj.x-l.position.x-v.ri.x,x.position.y+v.rj.y-l.position.y-v.ri.y,x.position.z+v.rj.z-l.position.z-v.ri.z);var T=I.dot(v.ni);if(0>T){n(u,w,1,!0),i(u,w,!0)!=i(u,w,!1)&&(l.dispatchEvent({type:"collide","with":x}),x.dispatchEvent({type:"collide","with":l}),l.wakeUp(),x.wakeUp());var C=l.velocity,S=l.angularVelocity,P=x.velocity,k=x.angularVelocity,A=v.ni,E=[g.t1,g.t2];A.tangents(E[0],E[1]);var V=C.vadd(S.cross(v.ri)),O=P.vadd(k.cross(v.rj)),D=O.vsub(V),R=k.cross(v.rj).vsub(S.cross(v.ri)),B=P.vsub(C),j=v.rj.cross(k).vsub(v.ri.cross(S));B.vsub(j,B);var N=l.invMass,L=x.invMass,F=l.invInertia.x,q=l.invInertia.y,W=l.invInertia.z,U=x.invInertia.x,X=x.invInertia.y,Y=x.invInertia.z,H=g.rixn,G=g.rjxn;v.ri.cross(A,H),v.rj.cross(A,G);var Q=A.mult(D.dot(A)*.5);H.unit().mult(R.dot(H.unit())),G.unit().mult(-R.dot(G.unit()));var $=v.ni.mult(T);if(this.solver.addConstraint([-A.x,-A.y,-A.z,-H.x,-H.y,-H.z,A.x,A.y,A.z,G.x,G.y,G.z],[N,N,N,F,q,W,L,L,L,U,X,Y],[-$.x,-$.y,-$.z,0,0,0,$.x,$.y,$.z,0,0,0],[-Q.x,-Q.y,-Q.z,0,0,0,Q.x,Q.y,Q.z,0,0,0],[l.force.x,l.force.y,l.force.z,l.tau.x,l.tau.y,l.tau.z,-x.force.x,-x.force.y,-x.force.z,-x.tau.x,-x.tau.y,-x.tau.z],0,"inf",u,w),b>0)for(var T=r.gravity.norm(),J=0;E.length>J;J++){var Z=E[J],K=v.ri.cross(Z),te=v.rj.cross(Z),ee=Z.mult(D.dot(Z));K.unit().mult(D.dot(K.unit())),te.unit().mult(-D.dot(te.unit())),this.solver.addConstraint([-Z.x,-Z.y,-Z.z,-K.x,-K.y,-K.z,Z.x,Z.y,Z.z,te.x,te.y,te.z],[N,N,N,F,q,W,L,L,L,U,X,Y],[0,0,0,0,0,0,0,0,0,0,0,0],[-ee.x,-ee.y,-ee.z,0,0,0,ee.x,ee.y,ee.z,0,0,0],[l.force.x,l.force.y,l.force.z,l.tau.x,l.tau.y,l.tau.z,x.force.x,x.force.y,x.force.z,x.tau.x,x.tau.y,x.tau.z],-b*100*(l.mass+x.mass),b*100*(l.mass+x.mass),u,w)}}}for(var u=0;this.constraints.length>u;u++){for(var x=-1,l=-1,w=0;this.bodies.length>w;w++)this.bodies[w].id===this.constraints[u].body_i.id?l=w:this.bodies[w].id===this.constraints[u].body_j.id&&(x=w);this.solver.addConstraint2(this.constraints[u],l,x)}var l;if(this.solver.n){this.solver.h=e,this.solver.solve();for(var u=0;a>u;u++)if(l=h[u],l.motionstate&t.Body.DYNAMIC){var ie=h[u];ie.velocity.x+=this.solver.vxlambda[u],ie.velocity.y+=this.solver.vylambda[u],ie.velocity.z+=this.solver.vzlambda[u],ie.angularVelocity&&(ie.angularVelocity.x+=this.solver.wxlambda[u],ie.angularVelocity.y+=this.solver.wylambda[u],ie.angularVelocity.z+=this.solver.wzlambda[u])}}for(var u=0;a>u;u++)if(l=h[u],l.motionstate&t.Body.DYNAMIC){var ne=1-l.linearDamping,se=1-l.angularDamping;l.velocity.mult(ne,l.velocity),l.angularVelocity&&l.angularVelocity.mult(se,l.angularVelocity)}r.dispatchEvent({type:"preStep"});for(var u in h){var l=h[u];l.preStep&&l.preStep.call(l)}g.step_q;for(var oe=g.step_w,re=g.step_wq,ae=t.Body.DYNAMIC|t.Body.KINEMATIC,u=0;a>u;u++){var ie=h[u];ie.motionstate&ae&&(ie.velocity.x+=ie.force.x*ie.invMass*e,ie.velocity.y+=ie.force.y*ie.invMass*e,ie.velocity.z+=ie.force.z*ie.invMass*e,ie.angularVelocity&&(ie.angularVelocity.x+=ie.tau.x*ie.invInertia.x*e,ie.angularVelocity.y+=ie.tau.y*ie.invInertia.y*e,ie.angularVelocity.z+=ie.tau.z*ie.invInertia.z*e),ie.isSleeping()||(ie.position.x+=ie.velocity.x*e,ie.position.y+=ie.velocity.y*e,ie.position.z+=ie.velocity.z*e,ie.angularVelocity&&(oe.set(ie.angularVelocity.x,ie.angularVelocity.y,ie.angularVelocity.z,0),oe.mult(ie.quaternion,re),ie.quaternion.x+=e*.5*re.x,ie.quaternion.y+=e*.5*re.y,ie.quaternion.z+=e*.5*re.z,ie.quaternion.w+=e*.5*re.w,o.stepnumber%3===0&&ie.quaternion.normalizeFast()))),ie.force.set(0,0,0),ie.tau&&ie.tau.set(0,0,0)}o.time+=e,o.stepnumber+=1,r.dispatchEvent({type:"postStep"});for(var u in h){var l=h[u];l.postStep&&l.postStep.call(l)}if(o.allowSleep)for(var u=0;a>u;u++){var l=h[u];l.sleepTick()}},t.ContactPoint=function(e,i,n,s,o){this.ri=new t.Vec3,this.rj=new t.Vec3,this.ni=new t.Vec3,n&&n.copy(this.ri),s&&s.copy(this.rj),o&&o.copy(this.ni),this.bi=e,this.bj=i},t.ContactGenerator=function(){function e(s,o,r,a,h,u,l,c,d){function p(e,n){if(i.length){var s=i.pop();return s.bi=e,s.bj=n,s}return new t.ContactPoint(e,n)}function _(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function y(t,i,n,s,o,r,a,h,u){for(var l=0;n.childShapes.length>l;l++){var c=[];e(c,i,n.childShapes[l],s,o.vadd(a.vmult(n.childOffsets[l])),r,a.mult(n.childOrientations[l]),h,u);for(var d=0;c.length>d;d++)c[d].rj.vadd(a.vmult(n.childOffsets[l]),c[d].rj),t.push(c[d])}}var f=!1;if(o.type>r.type){var g;g=r,r=o,o=g,g=h,h=a,a=g,g=l,l=u,u=g,g=d,d=c,c=g,f=!0}if(o.type==t.Shape.types.SPHERE){if(r.type==t.Shape.types.SPHERE){var m=p(c,d);h.vsub(a,m.ni),m.ni.normalize(),m.ni.copy(m.ri),m.ni.copy(m.rj),m.ri.mult(o.radius,m.ri),m.rj.mult(-r.radius,m.rj),s.push(m)}else if(r.type==t.Shape.types.PLANE){var m=p(c,d);r.normal.copy(m.ni),l.vmult(m.ni,m.ni),m.ni.negate(m.ni),m.ni.normalize(),m.ni.mult(o.radius,m.ri);var v=a.vsub(h),x=m.ni.mult(m.ni.dot(v));m.rj=v.vsub(x),x.norm()>o.radius||s.push(m)}else if(r.type==t.Shape.types.BOX){for(var w=a.vsub(h),b=r.getSideNormals(!0,l),z=o.radius,M=!1,I=0;b.length>I&&!M;I++){var T=b[I].copy(),C=T.norm();T.normalize();var S=w.dot(T);if(C+z>S&&S>0){var P=b[(I+1)%3].copy(),k=b[(I+2)%3].copy(),A=P.norm(),E=k.norm();P.normalize(),k.normalize();var V=w.dot(P),O=w.dot(k);if(A>V&&V>-A&&E>O&&O>-E){M=!0;var m=p(c,d);T.mult(-z,m.ri),T.copy(m.ni),m.ni.negate(m.ni),T.mult(C).vadd(P.mult(V)).vadd(k.mult(O),m.rj),s.push(m)}}}for(var D=n.get(),R=0;2>R&&!M;R++)for(var B=0;2>B&&!M;B++)for(var j=0;2>j&&!M;j++){D.set(0,0,0),R?D.vadd(b[0],D):D.vsub(b[0],D),B?D.vadd(b[1],D):D.vsub(b[1],D),j?D.vadd(b[2],D):D.vsub(b[2],D);var N=h.vadd(D).vsub(a);if(z>N.norm()){M=!0;var m=p(c,d);N.copy(m.ri),m.ri.normalize(),m.ri.copy(m.ni),m.ri.mult(z,m.ri),D.copy(m.rj),s.push(m)}}n.release(D),D=null;for(var L=n.get(),F=n.get(),m=n.get(),q=n.get(),W=n.get(),R=0;b.length>R&&!M;R++)for(var B=0;b.length>B&&!M;B++)if(R%3!=B%3){b[B].cross(b[R],L),L.normalize(),b[R].vadd(b[B],F),a.copy(m),m.vsub(F,m),m.vsub(h,m);var U=m.dot(L);L.mult(U,q);var j=0;while(j==R%3||j==B%3)j++;a.copy(W),W.vsub(q,W),W.vsub(F,W),W.vsub(h,W);var X=Math.abs(U),Y=W.norm();if(b[j].norm()>X&&z>Y){M=!0;var H=p(c,d);F.vadd(q,H.rj),H.rj.copy(H.rj),W.negate(H.ni),H.ni.normalize(),H.rj.copy(H.ri),H.ri.vadd(h,H.ri),H.ri.vsub(a,H.ri),H.ri.normalize(),H.ri.mult(z,H.ri),s.push(H)}}n.release(L,F,m,q,W)}else if(r.type==t.Shape.types.COMPOUND)y(s,o,r,a,h,u,l,c,d);else if(r.type==t.Shape.types.CONVEXPOLYHEDRON)throw Error("sphere/convexpolyhedron contacts not implemented yet.")}else if(o.type==t.Shape.types.PLANE){if(r.type==t.Shape.types.PLANE)throw"Plane-plane collision... wait, you did WHAT?";if(r.type==t.Shape.types.BOX)for(var G=o.normal.copy(),Q=0,$=r.getCorners(l),I=0;$.length>I&&4>=Q;I++){var m=p(c,d),J=$[I].vadd(h);$[I].copy(m.rj);var Z=J.vsub(a),K=G.dot(Z);if(0>=K){Q++;var te=G.mult(K);Z.vsub(te,m.ri),G.copy(m.ni),s.push(m)}}else if(r.type==t.Shape.types.COMPOUND)y(s,o,r,a,h,u,l,c,d);else if(r.type==t.Shape.types.CONVEXPOLYHEDRON){var ee=n.get(),ie=n.get();o.normal.tangents(ee,ie),ee.mult(1e5,ee),ie.mult(1e5,ie);var G=n.get();o.normal.copy(G);var ne=[new t.Vec3(-ee.x-ie.x-G.x,-ee.y-ie.y-G.y,-ee.z-ie.z-G.z),new t.Vec3(ee.x-ie.x+0*G.x,ee.y-ie.y+0*G.y,ee.z-ie.z+0*G.z),new t.Vec3(ee.x+ie.x-G.x,ee.y+ie.y-G.y,ee.z+ie.z-G.z),new t.Vec3(-ee.x+ie.x-G.x,-ee.y+ie.y-G.y,-ee.z+ie.z-G.z),new t.Vec3(-ee.x-ie.x+0*G.x,-ee.y-ie.y+0*G.y,-ee.z-ie.z+0*G.z),new t.Vec3(+ee.x-ie.x+0*G.x,ee.y-ie.y+0*G.y,ee.z-ie.z+0*G.z),new t.Vec3(+ee.x+ie.x+0*G.x,+ee.y+ie.y+0*G.y,ee.z+ie.z+0*G.z),new t.Vec3(-ee.x+ie.x+0*G.x,-ee.y+ie.y+0*G.y,-ee.z+ie.z+0*G.z)];ee.normalize(),ie.normalize();var se=new t.ConvexPolyhedron(ne,[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new t.Vec3(-G.x,-G.y,-G.z),new t.Vec3(G.x,G.y,G.z),new t.Vec3(-ie.x,-ie.y,-ie.z),new t.Vec3(ie.x,ie.y,ie.z),new t.Vec3(-ee.x,-ee.y,-ee.z),new t.Vec3(ee.x,ee.y,ee.z)]),oe=n.get();G.negate(oe);var re=n.get();if(r.testSepAxis(oe,se,h,l,a,u)!==!1){var H=[];se.clipAgainstHull(a,u,r,h,l,oe,-100,100,H);for(var R=0;H.length>R;R++){var m=p(c,d);oe.negate(m.ni),H[R].normal.negate(re),re.mult(H[R].depth,re),m.ri.set(H[R].point.x+re.x,H[R].point.y+re.y,H[R].point.z+re.z),m.rj.set(H[R].point.x,H[R].point.y,H[R].point.z),m.rj.vsub(h,m.rj),m.ri.vsub(a,m.ri),s.push(m)}}n.release(re,ee,ie,oe,G)}}else if(o.type==t.Shape.types.BOX)r.type==t.Shape.types.BOX?e(s,o.convexPolyhedronRepresentation,r.convexPolyhedronRepresentation,a,h,u,l,c,d):r.type==t.Shape.types.COMPOUND?y(s,o,r,a,h,u,l,c,d):r.type==t.Shape.types.CONVEXPOLYHEDRON&&e(s,o.convexPolyhedronRepresentation,r,a,h,u,l,c,d);else if(o.type==t.Shape.types.COMPOUND)r.type==t.Shape.types.COMPOUND?y(s,o,r,a,h,u,l,c,d):r.type==t.Shape.types.CONVEXPOLYHEDRON&&y(s,r,o,h,a,l,u,d,c);else if(o.type==t.Shape.types.CONVEXPOLYHEDRON&&r.type==t.Shape.types.CONVEXPOLYHEDRON){var oe=new t.Vec3;if(o.findSeparatingAxis(r,a,u,h,l,oe)){var H=[],re=new t.Vec3;o.clipAgainstHull(a,u,r,h,l,oe,-100,100,H);for(var R=0;H.length>R;R++){var m=p(c,d);oe.negate(m.ni),H[R].normal.negate(re),re.mult(H[R].depth,re),m.ri.set(H[R].point.x+re.x,H[R].point.y+re.y,H[R].point.z+re.z),m.rj.set(H[R].point.x,H[R].point.y,H[R].point.z),m.rj.vsub(h,m.rj),m.ri.vsub(a,m.ri),s.push(m)}}}for(var ae=0;f&&s.length>ae;ae++)_(s[ae])}this.contactReduction=!0;var i=[],n=new t.Vec3Pool;this.reduceContacts=function(){},this.getContacts=function(t,n,s,o,r){for(var a=0;r&&r.length>a;a++)i.push(r[a]);for(var h=0;t.length>h;h++){var u=t[h],l=n[h];e(o,u.shape,l.shape,u.position,l.position,u.quaternion,l.quaternion,u,l)}}},t.Constraint=function(){this.equations=[],this.id=-1},t.Constraint.prototype.constructor=t.Constraint,t.Constraint.prototype.update=function(){throw"update() not implemented in this Constraint subclass!"},t.ContactConstraint=function(e,i,n){t.Constraint.call(this),this.body_i=e,this.body_j=i,this.contact=contact,this.slipForce=n,this.unused_equations=[],this.temp={rixn:new t.Vec3,rjxn:new t.Vec3,t1:new t.Vec3,t2:new t.Vec3}},t.ContactConstraint.prototype=new t.Constraint,t.ContactConstraint.prototype.constructor=t.ContactConstraint,t.ContactConstraint.prototype.update=function(){var t=this.body_i,e=this.body_j,i=t.velocity,s=t.angularVelocity,o=e.velocity,r=e.angularVelocity,a=[this.temp.t1,this.temp.t2];for(var h in t.contacts)for(var u in e.contacts)if(t.contacts[h].to.id==e.id&&e.contacts[u].to.id==t.id){t.contacts[h].r,e.contacts[u].r,t.contacts[h].n,n.tangents(a[0],a[1]);var l=i.vadd(s.cross(c.ri)),d=o.vadd(r.cross(c.rj)),p=d.vsub(l),_=r.cross(c.rj).vsub(s.cross(c.ri)),y=o.vsub(i),f=c.rj.cross(r).vsub(c.ri.cross(s));y.vsub(f,y),t.invMass,e.invMass,t.invInertia.x,t.invInertia.y,t.invInertia.z,e.invInertia.x,e.invInertia.y,e.invInertia.z;var m=this.temp.rixn,v=this.temp.rjxn;c.ri.cross(n,m),c.rj.cross(n,v);var x=n.mult(p.dot(n));m.unit().mult(_.dot(m.unit())),v.unit().mult(-_.dot(v.unit()));var w=c.ni.mult(g);n.negate(eq.G1),m.negate(eq.G2),n.copy(eq.G3),v.copy(eq.G4),eq.setDefaultMassProps(),w.negate(eq.g1),w.copy(eq.g3),x.negate(eq.W1),x.copy(eq.W3),t.force.copy(eq.f1),t.tau.copy(eq.f2),e.force.copy(eq.f3),e.tau.copy(eq.f4),eq.lambdamin=0,eq.lambdamax="inf"}},t.DistanceConstraint=function(e,i,n){t.Constraint.call(this),this.body_i=e,this.body_j=i,this.distance=Number(n);var s=new t.Equation(e,i instanceof t.Vec3?null:i);this.equations.push(s)},t.DistanceConstraint.prototype=new t.Constraint,t.DistanceConstraint.prototype.constructor=t.DistanceConstraint,t.DistanceConstraint.prototype.update=function(){var t=this.equations[0],e=this.body_i,i=this.body_j,n=typeof i.mass=="number";n?i.position.vsub(e.position,t.G1):e.position.vsub(i,t.G1),t.G1.normalize(),t.G1.isZero()&&t.G1.set(1,0,0),t.G1.negate(t.G3),t.setDefaultMassProps(),t.setDefaultForce(),t.g1.set((n?i.position.x:i.x)-e.position.x-t.G1.x*this.distance,(n?i.position.y:i.y)-e.position.y-t.G1.y*this.distance,(n?i.position.z:i.z)-e.position.z-t.G1.z*this.distance),t.g1.negate(t.g1),t.g1.negate(t.g3)},t.DistanceConstraint.prototype.setMaxForce=function(t){this.equations[0].lambdamax=Math.abs(t),this.equations[0].lambdamin=-this.equations[0].lambdamax},t.Equation=function(e,i){this.G1=new t.Vec3,this.G2=new t.Vec3,this.G3=new t.Vec3,this.G4=new t.Vec3,this.iM1=new t.Vec3,this.iM2=new t.Vec3,this.iM3=new t.Vec3,this.iM4=new t.Vec3,this.g1=new t.Vec3,this.g2=new t.Vec3,this.g3=new t.Vec3,this.g4=new t.Vec3,this.W1=new t.Vec3,this.W2=new t.Vec3,this.W3=new t.Vec3,this.W4=new t.Vec3,this.f1=new t.Vec3,this.f2=new t.Vec3,this.f3=new t.Vec3,this.f4=new t.Vec3,this.lambdamax=1e6,this.lambdamin=-1e6,this.body_i=e,this.body_j=i},t.Equation.prototype.setDefaultMassProps=function(){var t=this.body_i,e=this.body_j;t&&(this.iM1.set(t.invMass,t.invMass,t.invMass),t.invInertia&&t.invInertia.copy(this.iM2)),e&&(this.iM3.set(e.invMass,e.invMass,e.invMass),e.invInertia&&e.invInertia.copy(this.iM4))},t.Equation.prototype.setDefaultForce=function(){var t=this.body_i,e=this.body_j;t&&(t.force.copy(this.f1),t.tau&&t.tau.copy(this.f2)),e&&(e.force.copy(this.f3),e.tau&&e.tau.copy(this.f4))},t.PointToPointConstraint=function(e,i,n,s){t.Constraint.call(this),this.body_i=e,this.body_j=n,this.pivot_i=i,this.pivot_j=s;for(var o=0;3>o;o++)this.equations.push(new Equation(e,n))},t.PointToPointConstraint.prototype=new t.Constraint,t.PointToPointConstraint.prototype.constructor=t.PointToPointConstraint,t.PointToPointConstraint.prototype.update=function(){},typeof module!="undefined"?module.exports=t:this.CANNON=t}.apply(this);var Ige$i_20Component=$i_3.extend({classId:"Ige$i_20Component",componentId:"cannon",init:function(t,e){this._entity=t,this._options=e,this._active=!0,this._sleep=!0,this._scaleRatio=1,this._solverIterations=10,this._gravity=new CANNON.Vec3(0,0,-60),this._broadphase=new CANNON.NaiveBroadphase,this._removeWhenReady=[],this._normalMaterial=new CANNON.Material("normalMaterial"),this._slipperyMaterial=new CANNON.Material("slipperyMaterial"),this._slipperyNormalCm=new CANNON.ContactMaterial(this._normalMaterial,this._slipperyMaterial,0,.3),ige.addBehaviour("cannonStep",this._behaviour)},sleep:function(t){return t!==void 0?(this._sleep=t,this._entity):this._sleep},scaleRatio:function(t){return t!==void 0?(this._scaleRatio=t,this._entity):this._scaleRatio},gravity:function(t,e,i){return t!==void 0&&e!==void 0?(this._gravity=new CANNON.Vec3(t,e,i),this._world&&this._world.gravity.set(this._gravity.x,this._gravity.y,this._gravity.z),this._entity):this._gravity},solverIterations:function(){return val!==void 0?(this._solverIterations=val,this._entity):this._solverIterations},createWorld:function(){return this._world=new CANNON.World,this._world.gravity.set(this._gravity.x,this._gravity.y,this._gravity.z),this._world.broadphase=this._broadphase,this._world.solver.iterations=this._solverIterations,this._world.allowSleep=this._sleep,this._world.addContactMaterial(this._slipperyNormalCm),this._entity},createFloor:function(t,e,i){var n=new CANNON.Plane(new CANNON.Vec3(t,e,i)),s=new CANNON.RigidBody(0,n,this._slipperyMaterial);this._world.add(s)},createBody:function(t,e){var i,n,s,o,r,a;switch(e.type){case"static":n=CANNON.Body.STATIC;break;case"kinematic":n=CANNON.Body.KINEMATIC;break;case"dynamic":n=CANNON.Body.DYNAMIC}for(i in e)if(e.hasOwnProperty(i))switch(i){case"fixtures":for(a=0;e.fixtures.length>a;a++)if(s=e.fixtures[a],s.shape)switch(s.shape.type){case"box":o=s.shape.data?s.shape.data.sizeX!==void 0&&s.shape.data.sizeY!==void 0&&s.shape.data.sizeZ!==void 0?new CANNON.Box(new CANNON.Vec3(s.shape.data.sizeX/this._scaleRatio,s.shape.data.sizeY/this._scaleRatio,s.shape.data.sizeZ/this._scaleRatio)):new CANNON.Box(new CANNON.Vec3(t.geometry.x2+1/this._scaleRatio,t.geometry.y2/this._scaleRatio,t.geometry.z2/this._scaleRatio)):new CANNON.Box(new CANNON.Vec3(t.geometry.x2+1/this._scaleRatio,t.geometry.y2+1/this._scaleRatio,t.geometry.z2+1/this._scaleRatio))}}return r=new CANNON.RigidBody(e.mass,o,this._normalMaterial),r.sleepSpeedLimit=.1,r.sleepTimeLimit=1e3,e.allowSleep!==void 0&&(r.allowSleep=e.allowSleep),e.sleepSpeedLimit!==void 0&&(r.sleepSpeedLimit=e.sleepSpeedLimit),e.sleepTimeLimit!==void 0&&(r.sleepTimeLimit=e.sleepTimeLimit),e.angularDamping!==void 0&&(r.angularDamping=e.angularDamping),e.linearDamping!==void 0&&(r.linearDamping=e.linearDamping),r.position.set(t._translate.x/this._scaleRatio,t._translate.y/this._scaleRatio,(t._translate.z+t.geometry.z2)/this._scaleRatio),r._igeEntity=t,this._world.add(r),r},enableDebug:function(t){var e=new this.b2DebugDraw;this._cannonDebug=!0,this._debugCanvas=document.getElementById(t),this._debugCtx=this._debugCanvas.getContext("2d"),e.SetSprite(this._debugCtx),e.SetDrawScale(this._scaleRatio),e.SetFillAlpha(.3),e.SetLineThickness(1),e.SetFlags(this.b2DebugDraw.e_controllerBit|this.b2DebugDraw.e_jointBit|this.b2DebugDraw.e_pairBit|this.b2DebugDraw.e_shapeBit),this._world.SetDebugDraw(e)},_behaviour:function(){var t,e,i=ige.cannon,n=i._world.bodies,s=n.length;if(i._active){i._world.step(1/60);while(s--)t=n[s],t._igeEntity&&t.isAwake()&&(e=t._igeEntity,t._igeUpdating=!0,e.translateTo(Math.ceil(t.position.x*i._scaleRatio),Math.ceil(t.position.y*i._scaleRatio),Math.ceil(t.position.z*i._scaleRatio-e.geometry.z2)),t._igeUpdating=!1);typeof i._updateCallback=="function"&&i._updateCallback()}}}),$i_39=$i_3.extend({classId:"$i_39",componentId:"cocoonJs",init:function(){this.detected=typeof ext!="undefined"&&ext.IDTK_APP!==void 0,this.detected&&this.log("CocoonJS support enabled!")},showInputDialog:function(t,e,i,n,s,o){this.detected?(t=t||"",e=e||"",i=i||"",n=n||"text",s=s||"Cancel",o=o||"OK",ext.IDTK_APP.makeCall("showTextDialog",t,e,i,n,s,o)):this.log("Cannot open CocoonJS input dialog! CocoonJS is not detected!","error")},showWebView:function(t){this.detected&&(ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('loadPath', '"+t+"')"),ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('show');"))},hideWebView:function(){this.detected&&ext.IDTK_APP.makeCall("forward","ext.IDTK_APP.makeCall('hide');")}}),$i_40={translateBy:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._translate.x+=t,this._translate.y+=e,this._translate.z+=i):this.log("translateBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},translateTo:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._translate.x=t,this._translate.y=e,this._translate.z=i):this.log("translateTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},translate:function(){return this.x=this._translateAccessorX,this.y=this._translateAccessorY,this.z=this._translateAccessorZ,this._entity||this},_translateAccessorTween:function(t,e,i){return new $i_47(this._translate,t,e,i)},_translateAccessorX:function(t){return t!==void 0?(this._translate.x=t,this._entity||this):this._translate.x},_translateAccessorY:function(t){return t!==void 0?(this._translate.y=t,this._entity||this):this._translate.y},_translateAccessorZ:function(t){return t!==void 0?(this._translate.z=t,this._entity||this):this._translate.z},rotateBy:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._rotate.x+=t,this._rotate.y+=e,this._rotate.z+=i):this.log("rotateBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},rotateTo:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._rotate.x=t,this._rotate.y=e,this._rotate.z=i):this.log("rotateTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},rotate:function(){return this.x=this._rotateAccessorX,this.y=this._rotateAccessorY,this.z=this._rotateAccessorZ,this._entity||this},_rotateAccessorTween:function(t,e,i){return new $i_47(this._rotate,t,e,i)},_rotateAccessorX:function(t){return t!==void 0?(this._rotate.x=t,this._entity||this):this._rotate.x},_rotateAccessorY:function(t){return t!==void 0?(this._rotate.y=t,this._entity||this):this._rotate.y},_rotateAccessorZ:function(t){return t!==void 0?(this._rotate.z=t,this._entity||this):this._rotate.z},scaleBy:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._scale.x+=t,this._scale.y+=e,this._scale.z+=i):this.log("scaleBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},scaleTo:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._scale.x=t,this._scale.y=e,this._scale.z=i):this.log("scaleTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},scale:function(){return this.x=this._scaleAccessorX,this.y=this._scaleAccessorY,this.z=this._scaleAccessorZ,this._entity||this},_scaleAccessorTween:function(t,e,i){return new $i_47(this._scale,t,e,i)},_scaleAccessorX:function(t){return t!==void 0?(this._scale.x=t,this._entity||this):this._scale.x},_scaleAccessorY:function(t){return t!==void 0?(this._scale.y=t,this._entity||this):this._scale.y},_scaleAccessorZ:function(t){return t!==void 0?(this._scale.z=t,this._entity||this):this._scale.z},originBy:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._origin.x+=t,this._origin.y+=e,this._origin.z+=i):this.log("originBy() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},originTo:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this._origin.x=t,this._origin.y=e,this._origin.z=i):this.log("originTo() called with a missing or undefined x, y or z parameter!","error"),this._entity||this},origin:function(){return this.x=this._originAccessorX,this.y=this._originAccessorY,this.z=this._originAccessorZ,this._entity||this},_originAccessorTween:function(t,e,i){return new $i_47(this._origin,t,e,i)},_originAccessorX:function(t){return t!==void 0?(this._origin.x=t,this._entity||this):this._origin.x},_originAccessorY:function(t){return t!==void 0?(this._origin.y=t,this._entity||this):this._origin.y},_originAccessorZ:function(t){return t!==void 0?(this._origin.z=t,this._entity||this):this._origin.z},_rotatePoint:function(t,e,i){var n=Math.cos(e),s=Math.sin(e);return{x:i.x+(t.x-i.x)*n+(t.y-i.y)*s,y:i.y-(t.x-i.x)*s+(t.y-i.y)*n}},updateTransform:function(){if(this._localMatrix.identity(),this._mode===0&&this._localMatrix.multiply(this._localMatrix._newTranslate(this._translate.x,this._translate.y)),this._mode===1){var t=this._translateIso=new $i_5(this._translate.x,this._translate.y,this._translate.z+this.geometry.z/2).toIso();this._parent&&this._parent.geometry.z&&(t.y+=this._parent.geometry.z/1.6),this._localMatrix.multiply(this._localMatrix._newTranslate(t.x,t.y))}this._localMatrix.multiply(this._localMatrix._newRotate(this._rotate.z)),this._localMatrix.multiply(this._localMatrix._newScale(this._scale.x,this._scale.y)),this._parent?(this._worldMatrix.copy(this._parent._worldMatrix),this._worldMatrix.multiply(this._localMatrix)):this._worldMatrix.copy(this._localMatrix)}};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_40);var $i_41={left:function(t){return t!==void 0?(this._uiX=t,this._uiXAlign="left",this._updateUiPosition(),this):this._uiX},center:function(t){return t!==void 0?(this._uiX=t,this._uiXAlign="center",this._updateUiPosition(),this):this._uiX},right:function(t){return t!==void 0?(this._uiX=t,this._uiXAlign="right",this._updateUiPosition(),this):this._uiX},top:function(t){return t!==void 0?(this._uiY=t,this._uiYAlign="top",this._updateUiPosition(),this):this._uiY},middle:function(t){return t!==void 0?(this._uiY=t,this._uiYAlign="middle",this._updateUiPosition(),this):this._uiY},bottom:function(t){return t!==void 0?(this._uiY=t,this._uiYAlign="bottom",this._updateUiPosition(),this):this._uiY},width:function(t,e,i){if(t!==void 0){if(this._width=t,this._widthModifier=e!==void 0?e:0,typeof t=="string")if(this._parent){var n=this._parent.geometry.x,s=parseInt(t,10);this.geometry.x=n/100*s+this._widthModifier|0,this.geometry.x2=Math.floor(this.geometry.x/2)}else{var n=ige.geometry.x,s=parseInt(t,10);this.geometry.x=n/100*s+this._widthModifier|0,this.geometry.x2=Math.floor(this.geometry.x/2)}else this.geometry.x=t,this.geometry.x2=Math.floor(this.geometry.x/2);return i||this._updateUiPosition(),this}return this._width},height:function(t,e,i){if(t!==void 0){if(this._height=t,this._heightModifier=e!==void 0?e:0,typeof t=="string")if(this._parent){var n=this._parent.geometry.y,s=parseInt(t,10);this.geometry.y=n/100*s+this._heightModifier|0,this.geometry.y2=Math.floor(this.geometry.y/2)}else{var n=ige.geometry.y,s=parseInt(t,10);this.geometry.y=n/100*s+this._heightModifier|0,this.geometry.y2=Math.floor(this.geometry.y/2)}else this.geometry.y=t,this.geometry.y2=Math.floor(this.geometry.y/2);return i||this._updateUiPosition(),this}return this._height},_updateUiPosition:function(){if(this._parent){var t=this._parent.geometry,e=this.geometry;this._width&&this.width(this._width,this._widthModifier,!0),this._height&&this.height(this._height,this._heightModifier,!0),this._uiXAlign==="right"?this._translate.x=Math.floor(t.x2-e.x2-this._uiX):this._uiXAlign==="center"?this._translate.x=Math.floor(this._uiX):this._uiXAlign==="left"&&(this._translate.x=Math.floor(this._uiX+e.x2-t.x2)),this._uiYAlign==="bottom"?this._translate.y=Math.floor(t.y2-e.y2-this._uiY):this._uiYAlign==="middle"?this._translate.y=Math.floor(this._uiY):this._uiYAlign==="top"&&(this._translate.y=Math.floor(this._uiY+e.y2-t.y2)),this.dirty(!0)}}};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_41);var $i_42={backgroundImage:function(t,e){if(t&&t.image){if(e||(e="no-repeat"),this._patternRepeat=e,this._patternTexture=t,this._backgroundSize?(t.resize(this._backgroundSize.x,this._backgroundSize.y),this._patternWidth=this._backgroundSize.x,this._patternHeight=this._backgroundSize.y):(this._patternWidth=t.image.width,this._patternHeight=t.image.height),this._cell>1){var i=document.createElement("canvas"),n=i.getContext("2d"),s=t._cells[this._cell];i.width=s[2],i.height=s[3],n.drawImage(t.image,s[0],s[1],s[2],s[3],0,0,s[2],s[3]),this._patternFill=ige._ctx.createPattern(i,e)}else this._patternFill=ige._ctx.createPattern(t.image,e);return t.restoreOriginal(),this.dirty(!0),this}return this._patternFill},backgroundSize:function(t,e){return t!==void 0&&e!==void 0?(typeof t=="string"&&(t=this.geometry.x/100*parseInt(t,10)),typeof e=="string"&&(e=this.geometry.y/100*parseInt(e,10)),this._backgroundSize={x:t,y:e},this._patternTexture&&this._patternRepeat&&this.backgroundImage(this._patternTexture,this._patternRepeat),this.dirty(!0),this):this._backgroundSize},backgroundColor:function(t){return t!==void 0?(this._backgroundColor=t,this.dirty(!0),this):this._backgroundColor},backgroundPosition:function(t,e){return t!==void 0&&e!==void 0?(this._backgroundPosition={x:t,y:e},this.dirty(!0),this):this._backgroundPosition},borderColor:function(t){return t!==void 0?(this._borderColor=t,this._borderLeftColor=t,this._borderTopColor=t,this._borderRightColor=t,this._borderBottomColor=t,this.dirty(!0),this):this._borderColor},borderLeftColor:function(t){return t!==void 0?(this._borderLeftColor=t,this.dirty(!0),this):this._borderLeftColor},borderTopColor:function(t){return t!==void 0?(this._borderTopColor=t,this.dirty(!0),this):this._borderTopColor},borderRightColor:function(t){return t!==void 0?(this._borderRightColor=t,this.dirty(!0),this):this._borderRightColor},borderBottomColor:function(t){return t!==void 0?(this._borderBottomColor=t,this.dirty(!0),this):this._borderBottomColor},borderWidth:function(t){return t!==void 0?(this._borderWidth=t,this._borderLeftWidth=t,this._borderTopWidth=t,this._borderRightWidth=t,this._borderBottomWidth=t,this.dirty(!0),this):this._borderWidth},borderLeftWidth:function(t){return t!==void 0?(this._borderLeftWidth=t,this.dirty(!0),this):this._borderLeftWidth},borderTopWidth:function(t){return t!==void 0?(this._borderTopWidth=t,this.dirty(!0),this):this._borderTopWidth},borderRightWidth:function(t){return t!==void 0?(this._borderRightWidth=t,this.dirty(!0),this):this._borderRightWidth
},borderBottomWidth:function(t){return t!==void 0?(this._borderBottomWidth=t,this.dirty(!0),this):this._borderBottomWidth},borderRadius:function(t){return t!==void 0?(this._borderRadius=t,this._borderTopLeftRadius=t,this._borderTopRightRadius=t,this._borderBottomRightRadius=t,this._borderBottomLeftRadius=t,this.dirty(!0),this):this._borderRadius},padding:function(t,e,i,n){return this._paddingLeft=t,this._paddingTop=e,this._paddingRight=i,this._paddingBottom=n,this.dirty(!0),this},paddingLeft:function(t){return t!==void 0?(this._paddingLeft=t,this.dirty(!0),this):this._paddingLeft},paddingTop:function(t){return t!==void 0?(this._paddingTop=t,this.dirty(!0),this):this._paddingTop},paddingRight:function(t){return t!==void 0?(this._paddingRight=t,this.dirty(!0),this):this._paddingRight},paddingBottom:function(t){return t!==void 0?(this._paddingBottom=t,this.dirty(!0),this):this._paddingBottom}};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_42);var $i_43={mouseMove:function(t){return t?(this._mouseMove=t,this._mouseEventsActive=!0,this):this._mouseMove},mouseMoveOff:function(){delete this._mouseMove},mouseOver:function(t){return t?(this._mouseOver=t,this._mouseEventsActive=!0,this):this._mouseOver},mouseOverOff:function(){delete this._mouseOver},mouseOut:function(t){return t?(this._mouseOut=t,this._mouseEventsActive=!0,this):this._mouseOut},mouseOutOff:function(){delete this._mouseOut},mouseUp:function(t){return t?(this._mouseUp=t,this._mouseEventsActive=!0,this):this._mouseUp},mouseUpOff:function(){delete this._mouseUp},mouseDown:function(t){return t?(this._mouseDown=t,this._mouseEventsActive=!0,this):this._mouseDown},mouseDownOff:function(){delete this._mouseDown},_handleMouseIn:function(t){this._mouseStateOver||(this._mouseStateOver=!0,this._mouseOver&&this._mouseOver(t)),this._mouseMove&&this._mouseMove(t)},_handleMouseOut:function(t){this._mouseStateDown=!1,this._mouseStateOver&&(this._mouseStateOver=!1,this._mouseOut&&this._mouseOut(t))},_handleMouseUp:function(t){this._mouseStateDown=!1,this._mouseUp&&this._mouseUp(t)},_handleMouseDown:function(t){this._mouseStateDown||(this._mouseStateDown=!0,this._mouseDown&&this._mouseDown(t))}};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_43);var nullMethod=function(){},$i_44={dummy:!0,save:nullMethod,restore:nullMethod,translate:nullMethod,rotate:nullMethod,scale:nullMethod,drawImage:nullMethod,fillRect:nullMethod,strokeRect:nullMethod,stroke:nullMethod,fill:nullMethod,rect:nullMethod,moveTo:nullMethod,lineTo:nullMethod,arc:nullMethod,clearRect:nullMethod,beginPath:nullMethod,clip:nullMethod,transform:nullMethod,setTransform:nullMethod,fillText:nullMethod};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_44);var $i_47=$i_2.extend({classId:"$i_47",init:function(t,e,i,n){this._targetObj=t,this._propertyObj=e!==void 0?e:{},this._durationMs=i!==void 0?i:0,this._started=!1,n&&n.easing?this.easing(n.easing):this.easing("none"),n&&n.startTime!==void 0&&this.startTime(n.startTime),n&&n.beforeTween!==void 0&&this.beforeTween(n.beforeTween),n&&n.afterTween!==void 0&&this.afterTween(n.afterTween)},targetObj:function(t){return t!==void 0&&(this._targetObj=t),this},properties:function(t){return t!==void 0&&(this._propertyObj=t),this},duration:function(t){return t!==void 0&&(this._durationMs=t),this},beforeTween:function(t){return t!==void 0&&(this._beforeTween=t),this},afterTween:function(t){return t!==void 0&&(this._afterTween=t),this},easing:function(t){return t!==void 0&&(this._easing=t),this},startTime:function(t){return t!==void 0&&(this._startTime=t),this},start:function(){return ige.tween.start(this),this._targetObj._tweenArr=this._targetObj._tweenArr||[],this._targetObj._tweenArr.push(this),this},stop:function(){return ige.tween.stop(this),this._targetObj._tweenArr.pull(this),this},startAll:function(){return this._targetObj._tweenArr&&this._targetObj._tweenArr.eachReverse(function(t){t.start()}),this},stopAll:function(){return this._targetObj._tweenArr&&this._targetObj._tweenArr.eachReverse(function(t){t.stop()}),this}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_47);var $i_48=$i_3.extend({classId:"$i_48",$i_48:!0,init:function(t){this._cells=[],t&&this.url(t)},id:function(t){if(t!==void 0){if(!ige._register[t])return this._id&&ige._register[this._id]&&ige.unRegister(this),this._id=t,ige.register(this),this;this.log('Cannot set ID of object to "'+t+'" because that ID is already in use by another object!',"error")}return this._id||(this._id=ige.newIdHex(),ige.register(this)),this._id},url:function(t){return t!==void 0?(this._url=t,t.substr(t.length-2,2)==="js"?this._loadScript(t):this._loadImage(t),this):this._url},_loadImage:function(t){var e,i=this;ige.isServer||(ige.textureLoadStart(t,this),ige._textureImageStore[t]?(e=this.image=this._originalImage=ige._textureImageStore[t],e._igeTextures.push(this),e._loaded&&(i._mode=0,i.sizeX(e.width),i.sizeY(e.height),i._cells[1]=[0,0,i._sizeX,i._sizeY],i._loaded=!0,setTimeout(function(){i.emit("loaded"),ige.textureLoadEnd(t,i)},1))):(e=ige._textureImageStore[t]=this.image=this._originalImage=new Image,e._igeTextures=e._igeTextures||[],e._igeTextures.push(this),e.onload=function(){this._loaded=!0,ige.log('Texture image "'+t+'" loaded successfully');var n,s,o=this._igeTextures,r=o.length;for(n=0;r>n;n++)s=o[n],s._mode=0,s.sizeX(e.width),s.sizeY(e.height),s._cells[1]=[0,0,s._sizeX,s._sizeY],s._loaded=!0,s.emit("loaded"),ige.textureLoadEnd(t,i)},e.src=t))},_loadScript:function(scriptUrl){var textures=ige.textures,rs_sandboxContext,self=this,scriptElem;ige.textureLoadStart(scriptUrl,this),ige.isServer||(scriptElem=document.createElement("script"),scriptElem.onload=function(data){self.log('Texture script "'+scriptUrl+'" loaded successfully'),eval(data),self._mode=1,self.script=image,typeof image.init=="function"&&image.init.apply(image,[self]),self._loaded=!0,self.emit("loaded"),ige.textureLoadEnd(scriptUrl,self)},scriptElem.addEventListener("error",function(){self.log("Error loading smart texture script file: "+scriptUrl,"error")},!0),scriptElem.src=scriptUrl,document.getElementsByTagName("head")[0].appendChild(scriptElem)),ige.isServer&&(rs_sandboxContext={},textures.fs.readFile(scriptUrl,this.bind(function(t,e){try{if(textures.vm.runInNewContext(e,rs_sandboxContext),typeof rs_sandboxContext.image=="object"){this.log('Texture script "'+scriptUrl+'" loaded successfully');var i=rs_sandboxContext.image;typeof i.init=="function"&&i.init.apply(i,[ige,this]),this.sizeX(i.width),this.sizeY(i.height),this._loaded=!0,self.emit("loaded"),ige.textureLoadEnd(scriptUrl,self)}else this.log("Error reading asset render script data. The script does not contain an image variable!","error",[this.url,rs_sandboxContext])}catch(n){this.log("Error executing asset render script: ","error",[n,this.url])}})))},sizeX:function(t){this._sizeX=t},sizeY:function(t){this._sizeY=t},resize:function(t,e,i){this._originalImage&&(this._textureCtx||(this._textureCanvas=document.createElement("canvas")),this._textureCanvas.width=t,this._textureCanvas.height=e,this._textureCtx=this._textureCanvas.getContext("2d"),i||this._textureCtx.drawImage(this._originalImage,0,0,this._originalImage.width,this._originalImage.height,0,0,t,e),this.image=this._textureCanvas)},restoreOriginal:function(){this.image=this._originalImage,delete this._textureCtx,delete this._textureCanvas},smoothing:function(t){return t!==void 0?(this._smoothing=t,this):this._smoothing},render:function(t,e){if(e._cell!==null){if(this._smoothing?(ige._ctx.imageSmoothingEnabled=!0,ige._ctx.webkitImageSmoothingEnabled=!0,ige._ctx.mozImageSmoothingEnabled=!0):(ige._ctx.imageSmoothingEnabled=!1,ige._ctx.webkitImageSmoothingEnabled=!1,ige._ctx.mozImageSmoothingEnabled=!1),this._mode===0){var i=this._cells[e._cell],n=e.geometry,s=e._renderPos;i?(this._preFilter&&this._textureCtx&&(this._textureCtx.save(),this._preFilter(this._textureCanvas,this._textureCtx,this._originalImage,this,this._preFilterData),this._textureCtx.restore()),t.drawImage(this.image,i[0],i[1],i[2],i[3],s.x,s.y,n.x,n.y),ige._drawCount++):this.log("Cannot render texture using cell "+e._cell+" because the cell does not exist in the assigned texture!","error")}this._mode===1&&(t.save(),this.script.render(t,e,this),t.restore(),ige._drawCount++)}},preFilter:function(t,e){return t!==void 0?(this._originalImage&&(this._textureCtx||(this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=this._originalImage.width,this._textureCanvas.height=this._originalImage.height,this._textureCtx=this._textureCanvas.getContext("2d")),this.image=this._textureCanvas,this._preFilter=t,this._preFilterData=e),this):(this.log("Cannot use pre-filter, no filter method was passed!","warning"),this._preFilter)},applyFilter:function(t,e){return t!==void 0?this._originalImage&&(this._textureCtx||(this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=this._originalImage.width,this._textureCanvas.height=this._originalImage.height,this._textureCtx=this._textureCanvas.getContext("2d")),this.image=this._textureCanvas,this._textureCtx.save(),t(this._textureCanvas,this._textureCtx,this._originalImage,this,e),this._textureCtx.restore()):this.log("Cannot apply filter, no filter method was passed!","warning"),this},stringify:function(){var t="new "+this.classId()+"('"+this._url+"')";return t+=".id('"+this.id()+"')",t+=this._stringify()},destroy:function(){delete this._eventListeners,this.image&&this.image._igeTextures&&this.image._igeTextures.pull(this),ige.TextureStore.pull(this),delete this.image,delete this.script,delete this._textureCanvas,delete this._textureCtx,this._destroyed=!0}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_48);var $i_50=$i_48.extend({classId:"$i_50",$i_50:!0,init:function(t,e){var i=this;this.on("loaded",function(){if(i.image){i._sheetImage=this.image;var t;for(t=0;e.length>t;t++)i._cells[t+1]=e[t]}else i.log("Cannot create cell-sheet because texture has not loaded an image!","error")}),this._super(t)},cellCount:function(){return this._cells.length},cellIdToIndex:function(t){var e,i=this._cells;for(e=1;i.length>e;e++)if(i[e][4]===t)return e;return-1},stringify:function(){var t="new "+this.classId()+"('"+this.url()+"', "+(this._cells+"")+")";return t+=".id('"+this.id()+"');"}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_50);var $i_52=$i_3.extend({classId:"$i_52",init:function(){this._alive=!0,this._mode=0,this._mountMode=0,this._parent=null,this._children=[],this._layer=0,this._depth=0,this._dirty=!0,this._depthSortMode=0,this._timeStream=[],this._inView=!0},alive:function(t){return t!==void 0?(this._alive=t,this):this._alive},id:function(t){if(t!==void 0){if(t===this._id)return this;if(!ige._register[t])return this._id&&ige._register[this._id]&&ige.unRegister(this),this._id=t,ige.register(this),this;ige._register[t]!==this&&this.log('Cannot set ID of object to "'+t+'" because that ID is already in use by another object!',"error")}return this._id||(this._id=ige.newIdHex(),ige.register(this)),this._id},group:function(t){return t!==void 0?(this._group=t,this):this._group},addBehaviour:function(t,e){if(typeof t=="string"){if(typeof e=="function")return this._behaviours=this._behaviours||[],this._behaviours.push({id:t,method:e}),this;this.log("The behaviour you passed is not a function! The second parameter of the call must be a function!","error")}else this.log("Cannot add behaviour to object because the specified behaviour id is not a string. You must provide two parameters with the addBehaviour() call, an id:String and a behaviour:Function. Adding a behaviour with an id allows you to remove it by it's id at a later stage!","error");return!1},removeBehaviour:function(t){if(t!==void 0){var e,i=this._behaviours;if(i){e=i.length;while(e--)if(i[e].id===t)return i.splice(e,1),this}}return!1},drawBounds:function(t){return t!==void 0?(this._drawBounds=t,this):this._drawBounds},drawBoundsData:function(t){return t!==void 0?(this._drawBoundsData=t,this):this._drawBoundsData},drawMouse:function(t){return t!==void 0?(this._drawMouse=t,this):this._drawMouse},parent:function(){return this._parent},children:function(){return this._children},mount:function(t){if(t){if(t._children){if(this.id(),this._parent){if(this._parent===t)return this;this.unMount()}return this._parent=t,t._children.push(this),this._parent._childMounted(this),this.emit("mounted",this._parent),this}return!1}this.log("Cannot mount non-existent object!","error")},unMount:function(){if(this._parent){var t=this._parent._children,e=t.indexOf(this);return e>-1?(t.splice(e,1),this._parent._childUnMounted(this),this._parent=null,this):!1}return!1},clone:function(){},mode:function(t){return t!==void 0?(this._mode=t,this):this._mode},isometric:function(t){return t===!0?(this._mode=1,this):t===!1?(this._mode=0,this):this._mode===1},isometricMounts:function(t){return t===!0?(this._mountMode=1,this):t===!1?(this._mountMode=0,this):this._mountMode===1},indestructible:function(t){return t!==void 0?(this._indestructible=t,this):this._indestructible},layer:function(t){return t!==void 0?(this._layer=t,this):this._layer},depth:function(t){return t!==void 0?(this._depth=t,this):this._depth},destroyChildren:function(){var t,e=this._children;if(e){t=e.length;while(t--)e[t].destroy()}return delete this._children,this},destroyBehaviours:function(){delete this._behaviours},destroyComponents:function(){var t,e=this._components;if(e){t=e.length;while(t--)e[t].destroy&&e[t].destroy()}return delete this._components,this},dirty:function(t){return t!==void 0?(this._dirty=t,this._parent&&this._parent.dirty(t),this):this._dirty},depthSortMode:function(t){return t!==void 0?(this._depthSortMode=t,this):this._depthSortMode},depthSortChildren:function(){var t,e,i,n,s=this._children;if(s&&(t=s.length,t>1))if(this._mountMode===1){if(this._depthSortMode===0){for(e={adj:[],c:[],p:[],order:[],order_ind:t-1},i=0;t>i;++i)for(e.c[i]=0,e.p[i]=-1,n=i+1;t>n;++n)e.adj[i]=e.adj[i]||[],e.adj[n]=e.adj[n]||[],s[i]._inView&&s[n]._inView&&s[i]._projectionOverlap&&s[n]._projectionOverlap&&s[i]._projectionOverlap(s[n])&&(s[i].isBehind(s[n])?e.adj[n].push(i):e.adj[i].push(n));for(i=0;t>i;++i)e.c[i]===0&&this._depthSortVisit(i,e);for(i=0;e.order.length>i;i++)s[e.order[i]].depth(i);this._children.sort(function(t,e){var i=e._layer-t._layer;return i===0?e._depth-t._depth:i})}if(this._depthSortMode===1&&this._children.sort(function(t,e){var i=e._layer-t._layer;return i===0?t.isBehind(e)?-1:1:i}),this._depthSortMode===2){while(t--)e=s[t],n=e._translate,n&&(e._depth=n.x+n.y+n.z);this._children.sort(function(t,e){var i=e._layer-t._layer;return i===0?e._depth-t._depth:i})}}else this._children.sort(function(t,e){var i=e._layer-t._layer;return i===0?e._depth-t._depth:i})},viewChecking:function(t){return t!==void 0?(this._viewChecking=t,this):this._viewChecking},viewCheckChildren:function(){var t,e=this._children,i=e.length,n=ige._currentViewport.viewArea();while(i--)t=e[i],t._inView=t._alwaysInView?!0:t.aabb?n.rectIntersect(t.aabb())?!0:!1:!1},tick:function(t){var e,i,n,s,o,r=this._children;if(this._viewChecking&&this.viewCheckChildren(),r)if(e=r.length,s=e,e&&!ige._headless&&(igeDebug.timing?(ige._tslt[this.id()]||(ige._tslt[this.id()]={}),i=(new Date).getTime(),this.depthSortChildren(),n=(new Date).getTime()-i,ige._tslt[this.id()].depthSortChildren=n):this.depthSortChildren()),o=e,igeDebug.timing)while(e--)t.save(),i=(new Date).getTime(),r[e].tick(t),n=(new Date).getTime()-i,r[e]&&(ige._tsit[r[e].id()]||(ige._tsit[r[e].id()]=0),ige._tslt[r[e].id()]||(ige._tslt[r[e].id()]={}),ige._tsit[r[e].id()]+=n,ige._tslt[r[e].id()].tick=n),t.restore();else while(e--)t.save(),r[e].tick(t),t.restore()},_depthSortVisit:function(t,e){var i,n,s=e.adj[t],o=s.length;for(e.c[t]=1,i=0;o>i;++i)n=s[i],e.c[n]===0&&(e.p[n]=t,this._depthSortVisit(n,e));e.c[t]=2,e.order[e.order_ind]=t,--e.order_ind},_resizeEvent:function(t){var e,i=this._children;if(i){e=i.length;while(e--)i[e]._resizeEvent(t)}},_processBehaviours:function(){if(ige._frameAlternator!==this._behaviourFA){var t,e=this._behaviours;if(e){t=e.length;while(t--)e[t].method.apply(this,arguments);this._behaviourFA=ige._frameAlternator}}},_childMounted:function(){this._resizeEvent(null)},_childUnMounted:function(){},destroy:function(){return this.unMount(),this._children&&this.destroyChildren(),this.destroyComponents(),this.destroyBehaviours(),ige.unRegister(this),this._alive=!1,delete this._eventListeners,this},stringify:function(){var t="new "+this.classId()+"()";return t+=".id('"+this.id()+"')",this.parent()&&(t+=".mount(ige.$('"+this.parent().id()+"'))"),t+=this._stringify()},_stringify:function(){var t,e="";for(t in this)if(this.hasOwnProperty(t)&&this[t]!==void 0)switch(t){case"_group":e+=".group('"+this.group()+"')";break;case"_drawBounds":e+=".drawBounds('"+this.drawBounds()+"')";break;case"_drawBoundsData":e+=".drawBoundsData('"+this.drawBoundsData()+"')";break;case"_drawMouse":e+=".drawMouse('"+this.drawMouse()+"')";break;case"_mode":e+=".mode('"+this.mode()+"')";break;case"_isometricMounts":e+=".isometricMounts('"+this.isometricMounts()+"')";break;case"_indestructible":e+=".indestructible('"+this.indestructible()+"')";break;case"_layer":e+=".layer('"+this.layer()+"')";break;case"_depth":e+=".depth('"+this.depth()+"')"}return e}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_52);var $i_53=$i_52.extend([{extension:$i_40,overwrite:!1},{extension:$i_43,overwrite:!0}],{classId:"$i_53",init:function(){this._super(),this._width=void 0,this._height=void 0,this._anchor=new $i_5(0,0,0),this._renderPos={x:0,y:0},this._opacity=1,this._cell=1,this._deathTime=void 0,this._oldTranslate=new $i_5(0,0,0),this._translate=new $i_5(0,0,0),this._rotate=new $i_5(0,0,0),this._scale=new $i_5(1,1,1),this._origin=new $i_5(.5,.5,.5),this.geometry=new $i_5(40,40,40),this._highlight=!1,this._mouseEventsActive=!1,this._localMatrix=new $i_8(this),this._worldMatrix=new $i_8(this),this._inView=!0,this.streamSections(["transform"])},mousePos:function(){var t;if(this._parent){if(this._parent.mousePos)return t=this._parent.mousePos(),new $i_5(t.x-this._translate.x,t.y-this._translate.y,0);throw"What happened? This code path should never be reached!"}return new $i_5(0,0,0)},translateToTile:function(t,e,i){if(this._parent&&this._parent._tileWidth!==void 0&&this._parent._tileHeight!==void 0){var n;n=i!==void 0?i*this._parent._tileWidth:this._translate.z,this.translateTo(t*this._parent._tileWidth,e*this._parent._tileHeight,n)}else this.log("Cannot translate to tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},widthByTile:function(t,e){if(this._parent&&this._parent._tileWidth!==void 0&&this._parent._tileHeight!==void 0){var i,n=this._mode===0?this._parent._tileWidth:this._parent._tileWidth*2;this.width(t*n),e&&(this._texture?(i=this._texture._sizeX/this.geometry.x,this.height(this._texture._sizeY/i)):this.log("Cannot set height based on texture aspect ratio and new width because no texture is currently assigned to the entity!","error"))}else this.log("Cannot set width by tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},heightByTile:function(t,e){if(this._parent&&this._parent._tileWidth!==void 0&&this._parent._tileHeight!==void 0){var i,n=this._mode===0?this._parent._tileHeight:this._parent._tileHeight*2;this.height(t*n),e&&(this._texture?(i=this._texture._sizeY/this.geometry.y,this.width(this._texture._sizeX/i)):this.log("Cannot set width based on texture aspect ratio and new height because no texture is currently assigned to the entity!","error"))}else this.log("Cannot set height by tile because the entity is not currently mounted to a tile map or the tile map has no tileWidth or tileHeight values.","warning");return this},occupyTile:function(){this.log("Cannot occupy a tile because the entity is not currently mounted to a tile sheet.","warning")},overTiles:function(){this.log("Cannot determine which tiles this entity lies over because the entity is not currently mounted to a tile sheet.","warning")},anchor:function(t,e){return t!==void 0&&e!==void 0?(this._anchor=new $i_5(t,e,0),this):this._anchor},width:function(t){return t!==void 0?(this._width=t,this.geometry.x=t,this.geometry.x2=t/2,this):this._width},height:function(t){return t!==void 0?(this._height=t,this.geometry.y=t,this.geometry.y2=t/2,this):this._height},size3d:function(t,e,i){return t!==void 0&&e!==void 0&&i!==void 0?(this.geometry=new $i_5(t,e,i),this):this.geometry},lifeSpan:function(t){return t!==void 0?(this.deathTime((new Date).getTime()+t),this):this.deathTime()-(new Date).getTime()},deathTime:function(t){return t!==void 0?(this._deathTime=t,this):this._deathTime},opacity:function(t){return t!==void 0?(this._opacity=t,this):this._opacity},texture:function(t){return t!==void 0?(this._texture=t,this):this._texture},cell:function(t){return t>0||t===null?(this._cell=t,this):this._cell},cellById:function(t){if(t!==void 0)if(this._texture){var e,i=this._texture,n=i._cells;for(e=1;n.length>e;e++)if(n[e][4]===t)return this.cell(e),this;this.log('Could not find the cell id "'+t+'" in the assigned entity texture '+i.id()+', please check your sprite sheet (texture) cell definition to ensure the cell id "'+t+'" has been assigned to a cell!',"error")}else this.log("Cannot assign cell index from cell ID until an $i_50 has been set as the texture for this entity. Please set the texture before calling cellById().","error");return this._cell},dimensionsFromTexture:function(){return this._texture&&(this.width(this._texture._sizeX),this.height(this._texture._sizeY)),this},dimensionsFromCell:function(){return this._texture&&(this.width(this._texture._cells[this._cell][2]),this.height(this._texture._cells[this._cell][3])),this},highlight:function(t){return t!==void 0?(this._highlight=t,this):this._highlight},localToWorld:function(t){this._worldMatrix.transform(t)},aabb:function(t){if(t||!this._aabb){var e,i,n,s,o,r,a,h,u,l=new $i_6,c=new $i_7(0,0,0,0),d=this._anchor,p=this.geometry,_=p.x,y=p.y,f=p.z,g=p.x2,m=p.y2,v=(p.z2,this._origin),x=v.x-.5,w=v.y-.5,b=v.z-.5;return this._mode===0&&(o=g+d.x,r=m+d.y,a=_*x,h=y*w,l.addPoint(-o+a,-r+h),l.addPoint(o+a,-r+h),l.addPoint(o+a,r+h),l.addPoint(-o+a,r+h),this._renderPos={x:-o+a,y:-r+h},this.localToWorld(l._poly),e=Math.min(l._poly[0].x,l._poly[1].x,l._poly[2].x,l._poly[3].x),i=Math.min(l._poly[0].y,l._poly[1].y,l._poly[2].y,l._poly[3].y),n=Math.max(l._poly[0].x,l._poly[1].x,l._poly[2].x,l._poly[3].x),s=Math.max(l._poly[0].y,l._poly[1].y,l._poly[2].y,l._poly[3].y),c.x=e,c.y=i,c.width=n-e,c.height=s-i),this._mode===1&&(u=new $i_5(-(p.x/2),-(p.y/2),p.z/2).toIso(),o=u.x+p.x+d.x,r=u.y+d.y,a=_*x,h=f*b,l.addPoint(-o+a,-r+h),l.addPoint(o+a,-r+h),l.addPoint(o+a,r+h),l.addPoint(-o+a,r+h),this._renderPos={x:-o+a,y:-r+h},this.localToWorld(l._poly),e=Math.min(l._poly[0].x,l._poly[1].x,l._poly[2].x,l._poly[3].x),i=Math.min(l._poly[0].y,l._poly[1].y,l._poly[2].y,l._poly[3].y),n=Math.max(l._poly[0].x,l._poly[1].x,l._poly[2].x,l._poly[3].x),s=Math.max(l._poly[0].y,l._poly[1].y,l._poly[2].y,l._poly[3].y),c.x=e,c.y=i,c.width=n-e,c.height=s-i),this._aabb=c,c}return this._aabb},_swapVars:function(t,e){return[e,t]},_internalsOverlap:function(t,e,i,n){var s;return t>e&&(s=this._swapVars(t,e),t=s[0],e=s[1]),i>n&&(s=this._swapVars(i,n),i=s[0],n=s[1]),t>i&&(s=this._swapVars(t,i),t=s[0],i=s[1],s=this._swapVars(e,n),e=s[0],n=s[1]),e>i},_projectionOverlap:function(t){var e=this.geometry,i=new $i_5(this._translate.x-e.x/2,this._translate.y-e.y/2,this._translate.z-e.z),n=new $i_5(this._translate.x+e.x/2,this._translate.y+e.y/2,this._translate.z+e.z),s=t.geometry,o=new $i_5(t._translate.x-s.x/2,t._translate.y-s.y/2,t._translate.z-s.z),r=new $i_5(t._translate.x+s.x/2,t._translate.y+s.y/2,t._translate.z+s.z);return this._internalsOverlap(i.x-n.y,n.x-i.y,o.x-r.y,r.x-o.y)&&this._internalsOverlap(i.x-n.z,n.x-i.z,o.x-r.z,r.x-o.z)&&this._internalsOverlap(i.z-n.y,n.z-i.y,o.z-r.y,r.z-o.y)},isBehind:function(t){var e=this.geometry,i=new $i_5(this._translate.x-e.x/2,this._translate.y-e.y/2,this._translate.z),n=new $i_5(this._translate.x+e.x/2,this._translate.y+e.y/2,this._translate.z+e.z),s=t.geometry,o=new $i_5(t._translate.x-s.x/2,t._translate.y-s.y/2,t._translate.z),r=new $i_5(t._translate.x+s.x/2,t._translate.y+s.y/2,t._translate.z+s.z);return n.x>o.x?r.x>i.x?n.y>o.y?r.y>i.y?n.z>o.z?r.z>i.z?this._translate.x+this._translate.y+this._translate.z>t._translate.x+t._translate.y+t._translate.z:!0:!1:!0:!1:!0:!1},mouseEventsActive:function(t){return t!==void 0?(this._mouseEventsActive=t,this):this._mouseEventsActive},tick:function(t,e){if(this._deathTime===void 0||ige.tickStart<this._deathTime){if(delete this._streamDataCache,this._processBehaviours(t),this._timeStream.length&&this._processInterpolate(ige.tickStart-ige.network.stream._renderLatency),this._inView&&(!this._parent||this._parent._inView)){var i,n,s,o,r=(ige._renderMode,this);this._mouseEventsActive&&(i=ige._currentViewport._mousePos,i&&(n=this.aabb(),s=i.x,o=i.y,n&&s>=n.x&&o>=n.y&&n.x+n.width>s&&n.y+n.height>o?ige.input.queueEvent(this,this._mouseInAabb):ige.input.mouseMove&&r._handleMouseOut(ige.input.mouseMove))),e||this._transformContext(t),this._renderEntity(t,e),this._streamMode===1&&this.streamSync()}this._super(t),this._oldTranslate=this._translate.clone()}else this.destroy()},_renderEntity:function(t){var e=this._texture;this._opacity>0&&e&&(e.render(t,this,ige.tickDelta),this._highlight&&(t.globalCompositeOperation="lighter",e.render(t,this)))},_transformContext:function(t){this.updateTransform(),this.aabb(!0),t.globalAlpha=this._parent?this._parent._opacity*this._opacity:this._opacity,this._localMatrix.transformRenderingContext(t)},_transformPoint:function(t){if(this._parent){var e=new $i_8;e.copy(this._parent._worldMatrix),e.multiply(this._localMatrix),e.transformCoord(t)}else this._localMatrix.transformCoord(t);return t},_mouseInAabb:function(t){ige.input.mouseMove&&this._handleMouseIn(ige.input.mouseMove,t),ige.input.mouseDown&&this._handleMouseDown(ige.input.mouseDown,t),ige.input.mouseUp&&this._handleMouseUp(ige.input.mouseUp,t)},_stringify:function(){var t,e=this._super();for(t in this)if(this.hasOwnProperty(t)&&this[t]!==void 0)switch(t){case"_opacity":e+=".opacity("+this.opacity()+")";break;case"_texture":e+=".texture(ige.$('"+this.texture().id()+"'))";break;case"_cell":e+=".cell("+this.cell()+")";break;case"_translate":e+=".translateTo("+this._translate.x+", "+this._translate.y+", "+this._translate.z+")";break;case"_rotate":e+=".rotateTo("+this._rotate.x+", "+this._rotate.y+", "+this._rotate.z+")";break;case"_scale":e+=".scaleTo("+this._scale.x+", "+this._scale.y+", "+this._scale.z+")";break;case"_origin":e+=".originTo("+this._origin.x+", "+this._origin.y+", "+this._origin.z+")";break;case"_anchor":e+=".anchor("+this._anchor.x+", "+this._anchor.y+")";break;case"_width":e+=typeof this.width()=="string"?".width('"+this.width()+"')":".width("+this.width()+")";break;case"_height":e+=typeof this.height()=="string"?".height('"+this.height()+"')":".height("+this.height()+")";break;case"geometry":e+=".size3d("+this.geometry.x+", "+this.geometry.y+", "+this.geometry.z+")";break;case"_deathTime":e+=".deathTime('"+this.deathTime()+"')";break;case"_highlight":e+=".highlight('"+this.highlight()+"')"}return e},destroy:function(){this._alive=!1,this.emit("destroyed",this),this._super()},streamSections:function(t){return t!==void 0?(this._streamSections=t,this):this._streamSections},streamSectionData:function(t,e,i){if(t==="transform"){if(!e)return this._translate.toString(this._streamFloatPrecision)+","+this._scale.toString(this._streamFloatPrecision)+","+this._rotate.toString(this._streamFloatPrecision)+",";var n=e.split(",");i?(n[0]&&(this._translate.x=parseFloat(n[0])),n[1]&&(this._translate.y=parseFloat(n[1])),n[2]&&(this._translate.z=parseFloat(n[2])),n[3]&&(this._scale.x=parseFloat(n[3])),n[4]&&(this._scale.y=parseFloat(n[4])),n[5]&&(this._scale.z=parseFloat(n[5])),n[6]&&(this._rotate.x=parseFloat(n[6])),n[7]&&(this._rotate.y=parseFloat(n[7])),n[8]&&(this._rotate.z=parseFloat(n[8]))):(n[0]&&(n[0]=parseFloat(n[0])),n[1]&&(n[1]=parseFloat(n[1])),n[2]&&(n[2]=parseFloat(n[2])),n[3]&&(n[3]=parseFloat(n[3])),n[4]&&(n[4]=parseFloat(n[4])),n[5]&&(n[5]=parseFloat(n[5])),n[6]&&(n[6]=parseFloat(n[6])),n[7]&&(n[7]=parseFloat(n[7])),n[8]&&(n[8]=parseFloat(n[8])),this._timeStream.push([ige.network.stream._streamDataTime+ige.network._latency,n]),this._timeStream.length>10&&this._timeStream.shift())}},interpolateValue:function(t,e,i,n,s){var o=e-t,r=s-i,a=n-i,h=a/r;return 0>h?h=0:h>1&&(h=1),o*h+t},_processInterpolate:function(t,e){e||(e=200);var i,n,s,o,r,a,h,u=this._timeStream,l=[],c=1;while(u[c]){if(u[c][0]>=t){i=u[c-1],n=u[c];break}c++}n||i?u.splice(0,c-1):u.length>2&&t>u[u.length-1][0]&&(i=u[u.length-2],n=u[u.length-1],u.shift(),this.emit("entityInterpolationLag")),n&&i&&(s=n[0]-i[0],o=t-i[0],r=o/s,0>r?r=0:r>1&&(r=1),a=i[1],h=n[1],l[0]=this.interpolateValue(a[0],h[0],i[0],t,n[0]),l[1]=this.interpolateValue(a[1],h[1],i[0],t,n[0]),l[2]=this.interpolateValue(a[2],h[2],i[0],t,n[0]),l[3]=this.interpolateValue(a[3],h[3],i[0],t,n[0]),l[4]=this.interpolateValue(a[4],h[4],i[0],t,n[0]),l[5]=this.interpolateValue(a[5],h[5],i[0],t,n[0]),l[6]=this.interpolateValue(a[6],h[6],i[0],t,n[0]),l[7]=this.interpolateValue(a[7],h[7],i[0],t,n[0]),l[8]=this.interpolateValue(a[8],h[8],i[0],t,n[0]),this.translateTo(parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])),this.scaleTo(parseFloat(l[3]),parseFloat(l[4]),parseFloat(l[5])),this.rotateTo(parseFloat(l[6]),parseFloat(l[7]),parseFloat(l[8])),this._lastUpdate=(new Date).getTime())}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_53);var $i_57=$i_2.extend({classId:"$i_57",init:function(t){this._mapData=t||[]},tileData:function(t,e,i){if(t!==void 0&&e!==void 0){if(i!==void 0)return this._mapData[e]=this._mapData[e]||[],this._mapData[e][t]=i,this;if(this._mapData[e])return this._mapData[e][t]}return void 0},clearData:function(t,e){return t!==void 0&&e!==void 0&&this._mapData[e]!==void 0?(delete this._mapData[e][t],!0):!1},collision:function(t,e,i,n){var s,o;if(i===void 0&&(i=1),n===void 0&&(n=1),t!==void 0&&e!==void 0)for(o=0;n>o;o++)for(s=0;i>s;s++)if(this.tileData(t+s,e+o))return!0;return!1},mapData:function(t){return t!==void 0?(this._mapData=t,this):this._mapData},mapDataString:function(){return JSON.stringify(this.mapData())},insertMapData:function(){},rotateData:function(t,e){switch(e){case-90:break;case 180:break;case 90:default:}}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_57);var $i_59=$i_53.extend({classId:"$i_59",init:function(t,e){this._alwaysInView=!0,this._super(),this.map=new $i_57,this._tileWidth=t!==void 0?t:40,this._tileHeight=e!==void 0?e:40,this._drawGrid=0},drawGrid:function(t){return t!==void 0?(this._drawGrid=t,this):this._drawGrid},highlightOccupied:function(t){return t!==void 0?(this._highlightOccupied=t,this):this._highlightOccupied},highlightTileRect:function(t){return t!==void 0?(this._highlightTileRect=t,this):this._highlightTileRect},tileWidth:function(t){return t!==void 0?(this._tileWidth=t,this):this._tileWidth},tileHeight:function(t){return t!==void 0?(this._tileHeight=t,this):this._tileHeight},_childMounted:function(t){t.occupyTile=this._objectOccupyTile,t.unOccupyTile=this._objectUnOccupyTile,t.overTiles=this._objectOverTiles,this._super(t)
},_objectOccupyTile:function(t,e,i,n){return t!==void 0&&e!==void 0?this._parent.occupyTile(t,e,i,n,this):this.overTiles(),this},_objectUnOccupyTile:function(t,e,i,n){return t!==void 0&&e!==void 0?this._parent.unOccupyTile(t,e,i,n):this.overTiles(),this},_objectOverTiles:function(){if(this._tileWidth&&this._tileHeight){var t,e;for(t=0;this._tileWidth>t;t++)for(e=0;this._tileHeight>e;e++);}else this.log('Cannot calculate which tiles this entity is currently "over" because it has not been assigned either a tileWidth or a tileHeight.',"error")},_resizeEvent:function(t){this.geometry=this._parent.geometry.clone(),this._super(t)},occupyTile:function(t,e,i,n,s){var o,r;if(i===void 0&&(i=1),n===void 0&&(n=1),t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),n=Math.floor(n),t!==void 0&&e!==void 0){for(o=0;i>o;o++)for(r=0;n>r;r++)this.map.tileData(t+o,e+r,s);s._classId&&(s._occupiedRect=new $i_7(t,e,i,n))}return this},unOccupyTile:function(t,e,i,n){var s,o,r;if(i===void 0&&(i=1),n===void 0&&(n=1),t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),n=Math.floor(n),t!==void 0&&e!==void 0)for(s=0;i>s;s++)for(o=0;n>o;o++)r=this.map.tileData(t+s,e+o),r&&r._occupiedRect&&delete r._occupiedRect,this.map.clearData(t+s,e+o);return this},isTileOccupied:function(t,e,i,n){return i===void 0&&(i=1),n===void 0&&(n=1),this.map.collision(t,e,i,n)},mouseDown:function(t){return t!==void 0?(this._tileMapMouseDown=t,this):this._tileMapMouseDown},mouseUp:function(t){return t!==void 0?(this._tileMapMouseUp=t,this):this._tileMapMouseUp},mouseOver:function(t){return t!==void 0?(this._tileMapMouseOver=t,this):this._tileMapMouseOver},pointToTile:function(t){var e,i,n,s=t.x,o=t.y;return this._mountMode===0&&(e=s+this._tileWidth/2,i=o+this._tileHeight/2,n=new $i_5(Math.floor(e/this._tileWidth),Math.floor(i/this._tileWidth))),this._mountMode===1&&(e=s,i=o-this._tileHeight/2,n=new $i_5(e,i,0).to2d(),n=new $i_5(Math.floor(n.x/this._tileWidth)+1,Math.floor(n.y/this._tileHeight)+1)),n},mouseTileWorldXY:function(){return this._mountMode===0?this._mouseTilePos.clone().thisMultiply(this._tileWidth,this._tileHeight,0):this._mountMode===1?this._mouseTilePos.clone().thisMultiply(this._tileWidth,this._tileHeight,0).thisToIso():void 0},mouseToTile:function(){return this.pointToTile(this.mousePos())},scanRects:function(t){var e,i,n=[],s=this.map._mapData.clone();for(i in s)if(s.hasOwnProperty(i))for(e in s[i])s[i].hasOwnProperty(e)&&s[i][e]&&(!t||t&&t(s[i][e],e,i))&&n.push(this._scanRects(s,parseInt(e,10),parseInt(i,10),t));return n},_scanRects:function(t,e,i,n){var s={x:e,y:i,width:1,height:1},o=e+1,r=i+1;t[i][e]=0;while(t[i][o]&&(!n||n&&n(t[i][o],o,i)))s.width++,t[i][o]=0,o++;while(t[r]&&t[r][e]&&(!n||n&&n(t[r][e],e,r))){if(t[r][e-1]&&(!n||n&&n(t[r][e-1],e-1,r))||t[r][e+s.width]&&(!n||n&&n(t[r][e+s.width],e+s.width,r)))return s;for(o=e;e+s.width>o;o++)if(!t[r][o]||n&&!n(t[r][o],o,r))return s;for(o=e;e+s.width>o;o++)t[r][o]=0;s.height++,r++}return s},_calculateMousePosition:function(){this._mouseTilePos=this.pointToTile(this.mousePos())},tick:function(t){var e,i,n,s,o,r,a,h,u=this._tileWidth,l=this._tileHeight;if(this._calculateMousePosition(),ige.input.mouseMove&&this._tileMapMouseOver&&this._tileMapMouseOver(this._mouseTilePos.x,this._mouseTilePos.y),ige.input.mouseDown&&this._tileMapMouseDown&&this._tileMapMouseDown(this._mouseTilePos.x,this._mouseTilePos.y),ige.input.mouseUp&&this._tileMapMouseUp&&this._tileMapMouseUp(this._mouseTilePos.x,this._mouseTilePos.y),this._transformContext(t),this._drawGrid>0){for(t.strokeStyle="#ffffff",gridCount=this._drawGrid,i=-(u/2),n=-(l/2),s=i+u*gridCount,o=n+l*gridCount,e=0;gridCount>=e;e++)r=new $i_5(i,n+l*e,0),a=new $i_5(s,n+l*e,0),this._mountMode===1&&(r=r.toIso(),a=a.toIso()),t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(a.x,a.y),t.stroke();for(e=0;gridCount>=e;e++)r=new $i_5(i+u*e,n,0),a=new $i_5(i+u*e,o,0),this._mountMode===1&&(r=r.toIso(),a=a.toIso()),t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(a.x,a.y),t.stroke()}if(this._highlightOccupied){t.fillStyle="#ff0000";for(n in this.map._mapData)if(this.map._mapData[n])for(i in this.map._mapData[n])this.map._mapData[n][i]&&(h=new $i_5(u*i,l*n,0),this._mountMode===0&&t.fillRect(h.x-u/2,h.y-l/2,u,l),this._mountMode===1&&(h.thisToIso(),t.beginPath(),t.moveTo(h.x,h.y-l/2),t.lineTo(h.x+u,h.y),t.lineTo(h.x,h.y+l/2),t.lineTo(h.x-u,h.y),t.lineTo(h.x,h.y-l/2),t.fill()))}if(this._highlightTileRect)for(t.fillStyle="#e4ff00",n=this._highlightTileRect.y;this._highlightTileRect.y+this._highlightTileRect.height>n;n++)for(i=this._highlightTileRect.x;this._highlightTileRect.x+this._highlightTileRect.width>i;i++)h=new $i_5(u*i,l*n,0),this._mountMode===0&&t.fillRect(h.x-u/2,h.y-l/2,u,l),this._mountMode===1&&(h.thisToIso(),t.beginPath(),t.moveTo(h.x,h.y-l/2),t.lineTo(h.x+u,h.y),t.lineTo(h.x,h.y+l/2),t.lineTo(h.x-u,h.y),t.lineTo(h.x,h.y-l/2),t.fill());this._drawMouse&&(t.fillStyle="#6000ff",this._mountMode===0&&t.fillRect(this._mouseTilePos.x*u-u/2,this._mouseTilePos.y*l-l/2,u,l),this._mountMode===1&&(h=this._mouseTilePos.clone().thisMultiply(u,l,0).thisToIso(),t.beginPath(),t.moveTo(h.x,h.y-l/2),t.lineTo(h.x+u,h.y),t.lineTo(h.x,h.y+l/2),t.lineTo(h.x-u,h.y),t.lineTo(h.x,h.y-l/2),t.fill())),this._super(t,!0)}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_59);var $i_48Map=$i_59.extend({classId:"$i_48Map",init:function(t,e){this._super(t,e),this.map=new $i_57,this._textureList=[],this._renderCenter=new $i_5(0,0,0),this._cacheDirty=!0},caching:function(t){return t!==void 0?(t===0&&(delete this._cache,delete this._cacheCtx),this._caching=t,this._caching>0&&this._renderArea&&this._resizeCacheCanvas(),this):this._caching},cacheForceFrame:function(){this._cacheDirty=!0},negate:function(t){if(t!==void 0){var e,i,n=t.map._mapData,s=this.map._mapData;for(i in n)if(n.hasOwnProperty(i))for(e in n[i])n[i].hasOwnProperty(e)&&s[i]&&s[i][e]&&delete s[i][e]}return this},addTexture:function(t){return this._textureList.push(t),this._textureList.length-1},paintTile:function(t,e,i,n){t!==void 0&&e!==void 0&&i!==void 0&&((n===void 0||1>n)&&(n=1),this.map.tileData(t,e,[i,n]))},clearTile:function(t,e){this.map.clearData(t,e)},_loadMapTextureLoaded:function(){this._loadMapTexturesLoading--,this._loadMapTexturesLoading===0&&this.emit("loadMapAllTexturesLoaded")},loadMap:function(map){if(map.textures){this._textureList=[],this._loadMapTexturesLoading=map.textures.length;var tex=[],i,self=this,_texLoaded=function(){self._loadMapTextureLoaded()};for(this.on("loadMapAllTexturesLoaded",function(){var t;for(t=0;map.textures.length>t;t++)self.addTexture(tex[t]);self.map.mapData(map.data)}),i=0;map.textures.length>i;i++)eval("tex["+i+"] = "+map.textures[0]),tex[i].on("loaded",_texLoaded)}else this.map.mapData(map.data);return this},saveMap:function(){var t,e,i,n=[],s=0,o=0,r=this.map._mapData;for(t=0;this._textureList.length>t;t++)n.push(this._textureList[t].stringify());for(i in r)if(r.hasOwnProperty(i))for(e in r[i])r[i].hasOwnProperty(e)&&(s>e&&(s=e),o>i&&(o=i));return JSON.stringify({textures:n,data:this.map.mapDataString(),dataXY:[s,o]})},tileTextureIndex:function(t,e,i){if(t!==void 0&&e!==void 0){var n=this.map.tileData(t,e);if(i===void 0)return n[0];n[0]=i}},tileTextureCell:function(t,e,i){if(t!==void 0&&e!==void 0){var n=this.map.tileData(t,e);if(i===void 0)return n[1];n[1]=i}},convertOldData:function(t){var e,i,n=[];for(e in t)if(t.hasOwnProperty(e))for(i in t[e])t[e].hasOwnProperty(i)&&(n[i]=n[i]||[],n[i][e]=t[e][i]);console.log(JSON.stringify(n))},renderArea:function(t,e,i,n){var s=!1;return this._renderArea?(t!==void 0&&(this._renderArea[0]=t,s=!0),e!==void 0&&(this._renderArea[1]=e,s=!0),i!==void 0&&(this._renderArea[2]=i,s=!0),n!==void 0&&(this._renderArea[3]=n,s=!0)):t!==void 0&&e!==void 0&&i!==void 0&&n!==void 0&&(this._renderArea=[t,e,i,n],s=!0),s?this:this._renderArea},renderAreaAutoSize:function(t,e){return t!==void 0?(this._renderAreaAutoSize=t,this._renderAreaAutoSizeOptions=e,this):this._renderAreaAutoSize},renderCenter:function(t,e){if(t!==void 0&&e!==void 0){var i;return this._mode===0&&(i=this._translate),this._mode===1&&(i=this._translate.toIso()),t-=i.x,e-=i.y,this._renderCenter&&this._renderCenter.x===t&&this._renderCenter.y===e||(this._renderCenter=new $i_5(t,e,0),this._cacheDirty=!0),this}return this._renderCenter},trackTranslate:function(t){return t!==void 0?(this._trackTranslateTarget=t,this):this._trackTranslateTarget},unTrackTranslate:function(){delete this._trackTranslateTarget},tick:function(t){this._super(t);var e,i,n,s,o,r,a=this.map._mapData,h=this._renderArea,u=this._newTileEntity();if(h)this._trackTranslateTarget&&(s=this._trackTranslateTarget.isometric()===!0?this._trackTranslateTarget._translate.toIso():this._trackTranslateTarget._translate,this.renderCenter(s.x,s.y)),this._caching>0?this._cacheDirty?this._caching===1&&this._cache&&this._cache[0]&&(o=this._cache[0],r=this._cacheCtx[0],this._cacheCtx[0].clearRect(0,0,o.width,o.height),r.save(),r.translate(o.width/2-this._renderCenter.x,o.height/2-this._renderCenter.y),this._renderMap(this._cacheCtx[0],u,a,h),r.restore(),this._renderMapCache(t,0,h),this._cacheDirty=!1):(this._renderMapCache(t,0,h),this._cacheDirty=!1):this._renderMap(t,u,a,h);else for(i in a)if(a.hasOwnProperty(i))for(e in a[i])a[i].hasOwnProperty(e)&&(n=a[i][e],n&&this._renderTile(t,e,i,n,u))},_renderMapCache:function(t,e,i){e===0&&t.drawImage(this._cache[e],-(i[2]/2)+this._renderCenter.x,-(i[3]/2)+this._renderCenter.y)},_renderMap:function(t,e,i,n){var s,o,r,a,h,u=this._renderCenter,l=this.pointToTile(this._renderCenter),c=l.x,d=l.y,p=Math.ceil(n[2]/this._tileWidth),_=Math.ceil(n[3]/this._tileHeight),y=new $i_7(n[0]+u.x,n[1]+u.y,n[2],n[3]);if(this._drawBounds&&(t.strokeStyle="#ff0000",t.strokeRect(y.x,y.y,y.width,y.height)),y.x-=this._tileWidth,y.y-=this._tileHeight/2,y.width+=this._tileWidth*2,y.height+=this._tileHeight,this._mountMode===0)for(o=d-Math.floor(_/2)-1;d+Math.floor(_/2)+1>=o;o++)if(i[o])for(s=c-Math.floor(p/2)-1;c+Math.floor(p/2)+1>=s;s++)r=i[o][s],r&&this._renderTile(t,s,o,r,e,y);if(this._mountMode===1)for(a=Math.abs(p)>Math.abs(_)?p:_,h=1,o=d-Math.floor(a*h);d+Math.floor(a*h)>=o;o++)if(i[o])for(s=c-Math.floor(a*h);c+Math.floor(a*h)>=s;s++)r=i[o][s],r&&this._renderTile(t,s,o,r,e,y)},_renderTile:function(t,e,i,n,s,o){var r,a;this._mountMode===0&&(r=e*this._tileWidth,a=i*this._tileHeight),this._mountMode===1&&(tx=e*this._tileWidth,ty=i*this._tileHeight,sx=tx-ty,sy=(tx+ty)*.5,r=sx,a=sy),(!o||o.xyInside(r,a))&&(t.save(),t.translate(r,a),texture=this._textureList[n[0]],s._cell=n[1],texture.render(t,s,ige.tickDelta),t.restore())},_resizeEvent:function(t){if(this._renderAreaAutoSize){var e=this._parent.geometry,i=0,n=0;this._renderAreaAutoSizeOptions&&(this._renderAreaAutoSizeOptions.bufferMultiple&&(i=e.x*this._renderAreaAutoSizeOptions.bufferMultiple.x-e.x,n=e.y*this._renderAreaAutoSizeOptions.bufferMultiple.y-e.y),this._renderAreaAutoSizeOptions.bufferPixels&&(i=this._renderAreaAutoSizeOptions.bufferPixels.x,n=this._renderAreaAutoSizeOptions.bufferPixels.y)),this.renderArea(-Math.floor((e.x+i)/2),-Math.floor((e.y+n)/2),e.x+i,e.y+n),this._caching>0&&this._resizeCacheCanvas()}this._super(t)},_resizeCacheCanvas:function(){switch(this._caching){case 1:this._cache=[],this._cacheCtx=[],this._cacheDirty=!0,canvas=document.createElement("canvas"),canvas.width=this._renderArea[2],canvas.height=this._renderArea[3],canvas.style.position="absolute",canvas.style.left="0px",canvas.style.top="0px",canvas.style.opacity="0",this._cache.push(canvas),this._cacheCtx.push(canvas.getContext("2d"))}},_newTileEntity:function(){return this._mountMode===0?{_cell:1,geometry:{x:this._tileWidth,y:this._tileHeight},_renderPos:{x:-this._tileWidth/2,y:-this._tileHeight/2}}:this._mountMode===1?{_cell:1,geometry:{x:this._tileWidth*2,y:this._tileHeight},_renderPos:{x:-this._tileWidth,y:-this._tileHeight/2}}:void 0}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_48Map);var $i_62=$i_53.extend({classId:"$i_62",init:function(t){this._super(),this._trackRotateTarget=void 0,this._trackTranslateTarget=void 0,this._trackRotateSmoothing=void 0,this._trackTranslateSmoothing=void 0,this._entity=t},limit:function(t){return t!==void 0?(this._limit=t,this._entity):this._limit},panTo:function(t,e,i){return t!==void 0&&this._translate.tween().properties({x:t.x,y:t.y,z:t.z}).duration(e).easing(i).start(),this._entity},panBy:function(t,e,i){return t!==void 0&&this._translate.tween().properties({x:t.x+this._translate.x,y:t.y+this._translate.y,z:t.z+this._translate.z}).duration(e).easing(i).start(),this._entity},trackTranslate:function(t,e){return t!==void 0?(this.log("Camera on viewport "+this._entity.id()+" is now tracking translation target "+t.id()),this._trackTranslateSmoothing=1>e?0:e,this._trackTranslateTarget=t,this._entity):this._trackTranslateTarget},trackTranslateSmoothing:function(t){return t!==void 0?(this._trackTranslateSmoothing=t,this):this._trackTranslateSmoothing},unTrackTranslate:function(){delete this._trackTranslateTarget},trackRotate:function(t,e){return t!==void 0?(this.log("Camera on viewport "+this._entity.id()+" is now tracking rotation of target "+t.id()),this._trackRotateSmoothing=1>e?0:e,this._trackRotateTarget=t,this._entity):this._trackRotateTarget},trackRotateSmoothing:function(t){return t!==void 0?(this._trackRotateSmoothing=t,this):this._trackRotateSmoothing},unTrackRotate:function(){delete this._trackRotateTarget},lookAt:function(t){return t!==void 0&&(t.updateTransform(),this._translate.x=t._worldMatrix.matrix[2],this._translate.y=t._worldMatrix.matrix[5],this.updateTransform()),this},tick:function(t){if(this._trackTranslateTarget){var e,i,n,s,o=this._trackTranslateTarget,r=o._worldMatrix.matrix,a=r[2],h=r[5];this._trackTranslateSmoothing?(e=this._translate.x,i=this._translate.y,n=a-e,s=h-i,this._translate.x+=n/this._trackTranslateSmoothing,this._translate.y+=s/this._trackTranslateSmoothing):this.lookAt(this._trackTranslateTarget)}if(this._trackRotateTarget){var u,l,c=this._trackRotateTarget._parent!==void 0?this._trackRotateTarget._parent._rotate.z:0,d=-(c+this._trackRotateTarget._rotate.z);this._trackRotateSmoothing?(u=this._rotate.z,l=d-u,this._rotate.z+=l/this._trackRotateSmoothing):this._rotate.z=d}this.updateTransform(),this._localMatrix.transformRenderingContext(t)},updateTransform:function(){if(this._localMatrix.identity(),this._localMatrix.multiply(this._localMatrix._newRotate(this._rotate.z)),this._localMatrix.multiply(this._localMatrix._newScale(this._scale.x,this._scale.y)),this._mode===0&&this._localMatrix.multiply(this._localMatrix._newTranslate(-this._translate.x,-this._translate.y)),this._mode===1){var t=this._translateIso=new $i_5(this._translate.x,this._translate.y,this._translate.z+this.geometry.z/2).toIso();this._parent&&this._parent.geometry.z&&(t.y+=this._parent.geometry.z/1.6),this._localMatrix.multiply(this._localMatrix._newTranslate(t.x,t.y))}this._parent?(this._worldMatrix.copy(this._parent._worldMatrix),this._worldMatrix.multiply(this._localMatrix)):this._worldMatrix.copy(this._localMatrix)},_stringify:function(){var t,e=this._super();for(t in this)if(this.hasOwnProperty(t)&&this[t]!==void 0)switch(t){case"_trackTranslateTarget":e+=".trackTranslate(ige.$('"+this._trackTranslateTarget.id()+"'), "+this.trackTranslateSmoothing()+")";break;case"_trackRotateTarget":e+=".trackRotate(ige.$('"+this._trackRotateTarget.id()+"'), "+this.trackRotateSmoothing()+")"}return e}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_62);var $i_63=$i_53.extend([{extension:$i_42,overwrite:!0},{extension:$i_41,overwrite:!0}],{classId:"$i_63",init:function(t){this._alwaysInView=!0,this._super(),this._mousePos=new $i_5(0,0,0),this._overflow="",this._uiX=0,this._uiY=0,t===void 0&&(t={left:0,top:0,width:ige.geometry.x,height:ige.geometry.y,autoSize:!0}),this.geometry=new $i_5(t.width||250,t.height||150,0),this.camera=new $i_62(this),this.camera._entity=this},autoSize:function(t){return t!==void 0?(this._autoSize=t,this):this._autoSize},scene:function(t){return t!==void 0?(this._scene=t,this):this._scene},mousePos:function(){return this._mousePos},viewArea:function(){var t=this.aabb(),e=this.camera._translate;return new $i_7(t.x+e.x,t.y+e.y,t.width,t.height)},tick:function(t,e){if(this._scene&&(ige._currentCamera=this.camera,ige._currentViewport=this,this._scene._parent=this,this._super(t),t.translate(-(this.geometry.x*this._origin.x)|0,-(this.geometry.y*this._origin.y)|0),t.clearRect(0,0,this.geometry.x,this.geometry.y),(!ige.cocoonJs||ige.cocoonJs&&!ige.cocoonJs.detected)&&(t.beginPath(),t.rect(0,0,this.geometry.x,this.geometry.y),this._borderColor&&(t.strokeStyle=this._borderColor,t.stroke()),t.clip()),t.translate(this.geometry.x/2|0,this.geometry.y/2|0),this.camera.tick(t),t.save(),this._scene.tick(t,e),t.restore(),this._drawBounds&&t===ige._ctx&&this.drawAABBs(t,this._scene,0),this._drawMouse&&t===ige._ctx&&this._mousePos)){t.save(),t.scale(1/this.camera._scale.x,1/this.camera._scale.y);var i,n=Math.floor(this._mousePos.x*this.camera._scale.x),s=Math.floor(this._mousePos.y*this.camera._scale.y);t.fillStyle="#fc00ff",t.fillRect(n-5,s-5,10,10),i=t.measureText("Viewport "+this.id()+" :: "+n+", "+s),t.fillText("Viewport "+this.id()+" :: "+n+", "+s,n-i.width/2,s-15),t.restore()}},drawAABBs:function(t,e,i){var n,s,o,r,a,h,u,l,c,d,p,_,y,f,g,m,v,x,w,b=e._children;if(b){n=b.length;while(n--)s=b[n],i++,s._shouldRender!==!1&&(typeof s.aabb=="function"&&(o=s.aabb(),o&&((s._drawBounds||s._drawBounds===void 0)&&(t.strokeStyle="#00deff",t.strokeRect(o.x,o.y,o.width,o.height),s._parent&&s._parent._mountMode===1&&(t.save(),t.translate(o.x+o.width/2,o.y+o.height/2),a=s.geometry,h=new $i_5(-(a.x/2),0,0).toIso(),u=new $i_5(+(a.x/2),0,0).toIso(),l=new $i_5(0,-(a.y/2),0).toIso(),c=new $i_5(0,+(a.y/2),0).toIso(),d=new $i_5(0,0,-(a.z/2)).toIso(),p=new $i_5(0,0,+(a.z/2)).toIso(),_=new $i_5(-(a.x/2),-(a.y/2),-(a.z/2)).toIso(),y=new $i_5(+(a.x/2),-(a.y/2),-(a.z/2)).toIso(),f=new $i_5(+(a.x/2),+(a.y/2),-(a.z/2)).toIso(),g=new $i_5(-(a.x/2),+(a.y/2),-(a.z/2)).toIso(),m=new $i_5(-(a.x/2),-(a.y/2),a.z/2).toIso(),v=new $i_5(+(a.x/2),-(a.y/2),a.z/2).toIso(),x=new $i_5(+(a.x/2),+(a.y/2),a.z/2).toIso(),w=new $i_5(-(a.x/2),+(a.y/2),a.z/2).toIso(),r=t.globalAlpha,t.globalAlpha=1,t.strokeStyle="#ff0000",t.beginPath(),t.moveTo(h.x,h.y),t.lineTo(u.x,u.y),t.stroke(),t.strokeStyle="#00ff00",t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(c.x,c.y),t.stroke(),t.strokeStyle="#fffc00",t.beginPath(),t.moveTo(d.x,d.y),t.lineTo(p.x,p.y),t.stroke(),t.strokeStyle="#a200ff",t.globalAlpha=.6,t.fillStyle="#545454",t.beginPath(),t.moveTo(f.x,f.y),t.lineTo(g.x,g.y),t.lineTo(w.x,w.y),t.lineTo(x.x,x.y),t.lineTo(f.x,f.y),t.fill(),t.stroke(),t.fillStyle="#282828",t.beginPath(),t.moveTo(f.x,f.y),t.lineTo(y.x,y.y),t.lineTo(v.x,v.y),t.lineTo(x.x,x.y),t.lineTo(f.x,f.y),t.fill(),t.stroke(),t.fillStyle="#676767",t.beginPath(),t.moveTo(m.x,m.y),t.lineTo(v.x,v.y),t.lineTo(x.x,x.y),t.lineTo(w.x,w.y),t.lineTo(m.x,m.y),t.fill(),t.stroke(),t.globalAlpha=r,t.restore())),this._drawBoundsData&&(s._drawBounds||s._drawBoundsData===void 0)&&(t.globalAlpha=1,t.fillStyle="#f6ff00",t.fillText("ID: "+s.id()+" "+"("+s.classId()+") "+s.layer()+":"+s.depth().toFixed(0),o.x+o.width+3,o.y+10),t.fillText("X: "+s._translate.x.toFixed(2)+", "+"Y: "+s._translate.y.toFixed(2)+", "+"Z: "+s._translate.z.toFixed(2),o.x+o.width+3,o.y+20)))),this.drawAABBs(t,s,i))}},_resizeEvent:function(t){this._autoSize&&this._parent&&(this.geometry=this._parent.geometry.clone()),this._updateUiPosition(),this._scene&&this._scene._resizeEvent(t)},_stringify:function(){var t,e=this._super();for(t in this)if(this.hasOwnProperty(t)&&this[t]!==void 0)switch(t){case"_autoSize":e+=".autoSize("+this._autoSize+")";break;case"_scene":e+=".scene(ige.$('"+this.scene().id()+"'))"}return e}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_63);var $i_64=$i_53.extend({classId:"$i_64",init:function(){this._alwaysInView=!0,this._super(),this._shouldRender=!0,this._autoSize=!0,this.geometry.x=ige.geometry.x,this.geometry.y=ige.geometry.y},autoSize:function(t){return t!==void 0?(this._autoSize=t,this):this._autoSize},shouldRender:function(t){return t!==void 0?(this._shouldRender=t,this):this._shouldRender},ignoreCamera:function(t){return t!==void 0?(this._ignoreCamera=t,this):this._ignoreCamera},tick:function(t){if(this._shouldRender){if(this._ignoreCamera){var e=ige._currentCamera;this.translateTo(e._translate.x,e._translate.y,e._translate.z)}this._super(t)}},_resizeEvent:function(t){this._autoSize&&(this.geometry=ige.geometry.clone());var e=this._children,i=e.length;while(i--)e[i]._resizeEvent(t)},_stringify:function(){var t,e=this._super();for(t in this)if(this.hasOwnProperty(t)&&this[t]!==void 0)switch(t){case"_shouldRender":e+=".shouldRender("+this.shouldRender()+")";break;case"_autoSize":e+=".autoSize("+this.autoSize()+")"}return e}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_64);var $i_53$i_20=$i_53.extend({classId:"$i_53$i_20",init:function(){this._super(),this._translateToProto=this.translateTo,this._translateByProto=this.translateBy,this.translateTo=this._translateTo,this.translateBy=this._translateBy},cannonBody:function(t){return t!==void 0?(this._cannonBodyDef=t,this._cannonBody=ige.cannon.createBody(this,t),this):this._cannonBodyDef},_translateTo:function(t,e,i){var n=this._cannonBody,s=ige.cannon._scaleRatio;return n&&!n._igeUpdating&&(n.position.x=t/s,n.position.y=e/s,n.position.z=(i+this.geometry.z2)/s),this._translateToProto(t,e,i),this},_translateBy:function(t,e,i){this._translateTo(this._translate.x+t,this._translate.y+e,this._translate.z+i)}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_53$i_20);var $i_88=$i_53.extend({classId:"$i_88",init:function(){this._alwaysInView=!0,this._super(),this._id="ige",this.basePath="",this.isServer=typeof module!="undefined"&&module.exports!==void 0,ige=this,console.log("------------------------------------------------------------------------------"),console.log("* Powered by the Isogenic Game Engine "+igeVersion+"                                  *"),console.log("* (C)opyright 2012 Irrelon Software Limited                                  *"),console.log("* http://www.isogenicengine.com                                              *"),console.log("------------------------------------------------------------------------------"),this._super(),this.isServer||this.addComponent($i_39),this.ClassStore={},this.TextureStore=[],this._idCounter=(new Date).getTime(),this.addComponent($i_14),this.addComponent($i_12),this._renderModes=["2d","three"],this._renderContext="2d",this._renderMode=this._renderModes[this._renderContext],this._tickTime="NA",this.tickDelta=0,this._fpsRate=60,this._state=0,this._textureImageStore={},this._texturesLoading=0,this._texturesTotal=0,this._dependencyQueue=[],this._drawCount=0,this._dps=0,this._frames=0,this._fps=0,this._clientNetDiff=0,this._frameAlternator=!1,this._viewportDepth=!1,this._mousePos=new $i_5(0,0,0),this._currentViewport=null,this._currentCamera=null,this._register={ige:this},this._postTick=[],this._tsit={},this._tslt={},this._ctx=$i_44,this._headless=!0,this.dependencyTimeout(3e4),this._dependencyQueue.push(this.texturesLoaded),setInterval(this._secondTick,1e3)},$:function(t){return typeof t=="string"?this._register[t]:typeof t=="object"?t:this},$$:function(){},register:function(t){return t!==void 0?this._register[t.id()]?(t._registered=!1,this.log('Cannot add object id "'+t.id()+'" to scenegraph because there is already another object in the graph with the same ID!',"error"),!1):(this._register[t.id()]=t,t._registered=!0,this):this._register},unRegister:function(t){return t!==void 0&&this._register[t.id()]&&(delete this._register[t.id()],t._registered=!1),this},setFps:function(t){t!==void 0&&(this.isServer?requestAnimFrame=function(e){setTimeout(function(){e((new Date).getTime())},1e3/t)}:window.requestAnimFrame=function(e){setTimeout(function(){e((new Date).getTime())},1e3/t)})},showStats:function(t){if(t!==void 0){switch(t){case 0:this._removeStatsDiv();break;case 1:this._createStatsDiv()}return this._showStats=t,this}return this._showStats},_createStatsDiv:function(){if(!ige.isServer&&!document.getElementById("igeStats")){var t=document.createElement("div");t.style.fontFamily="Verdana, Tahoma",t.style.fontSize="12px",t.style.position="absolute",t.style.color="#ffffff",t.style.textShadow="1px 1px 3px #000000",t.style.bottom="10px",t.style.left="10px",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.MozkitUserSelect="none",t.style.zIndex=1e5,t.innerHTML="Please wait...",window.addEventListener("load",function(){document.body.appendChild(t)}),window.addEventListener("unload",function(){}),this._statsDiv=t}},_removeStatsDiv:function(){document.body.removeChild(this._statsDiv),delete this._statsDiv},defineClass:function(t,e){ige.ClassStore[t]=e},getClass:function(t){return ige.ClassStore[t]},newClassInstance:function(t,e){return new ige.ClassStore[t](e)},dependencyCheck:function(){var t=this._dependencyQueue,e=t.length;while(e--)if(!this._dependencyQueue[e]())return!1;return!0},viewportDepth:function(t){return t!==void 0?(this._viewportDepth=t,this):this._viewportDepth},dependencyTimeout:function(t){this._dependencyCheckTimeout=t},textureLoadStart:function(t,e){this._texturesLoading++,this._texturesTotal++,this.emit("textureLoadStart",e)},textureLoadEnd:function(t,e){e._destroyed||this.TextureStore.push(e),this._texturesLoading--,this.emit("textureLoadEnd",e),this._texturesLoading===0&&this._allTexturesLoaded()},textureFromUrl:function(t){var e,i=this.TextureStore,n=i.length;while(n--)if(e=i[n],e._url===t)return e},texturesLoaded:function(){return ige._texturesLoading===0},_allTexturesLoaded:function(){this._loggedATL||(this._loggedATL=!0,this.log("All textures have loaded")),this.emit("texturesLoaded")},canvasReady:function(){return ige._canvas!==void 0||ige.isServer},newId:function(){return this._idCounter++,this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))+""},newIdHex:function(){return this._idCounter++,(this._idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16)},start:function(t){if(!ige._state)if(ige.dependencyCheck())ige.log("Starting engine..."),ige._state=1,requestAnimFrame(ige.tick),ige.log("Engine started"),typeof t=="function"&&t(!0);else{var e=(new Date).getTime();ige._dependencyCheckStart||(ige._dependencyCheckStart=e),e-ige._dependencyCheckStart>this._dependencyCheckTimeout?(this.log("Engine start failed because the dependency check timed out after "+this._dependencyCheckTimeout/1e3+" seconds","error"),typeof t=="function"&&t(!1)):setTimeout(function(){ige.start(t)},200)}},stop:function(){return this._state?(this.log("Stopping engine..."),this._state=0,!0):!1},autoSize:function(t){return t!==void 0?(this._autoSize=t,this):this._autoSize},pixelRatioScaling:function(t){return t!==void 0?(this._pixelRatioScaling=t,this):this._pixelRatioScaling},renderContext:function(t){return t!==void 0?(this._renderContext=t,this._renderMode=this._renderModes[t],this.log("Rendering mode set to: "+t),this):this._renderContext},createFrontBuffer:function(t,e){this.isServer||this._canvas||(this._createdFrontBuffer=!0,this._pixelRatioScaling=!e,this._frontBufferSetup(t,e))},_frontBufferSetup:function(t){var e,i=document.createElement("canvas");this._pixelRatioScaling?(e=i.getContext(ige._renderContext),this._devicePixelRatio=window.devicePixelRatio||1,this._backingStoreRatio=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,this._deviceFinalDrawRatio=this._devicePixelRatio/this._backingStoreRatio):(this._devicePixelRatio=1,this._backingStoreRatio=1,this._deviceFinalDrawRatio=1),i.id="igeFrontBuffer",this.canvas(i,t),document.body.appendChild(i)},canvas:function(t,e){this._canvas||(this._canvas=t,e&&(this._autoSize=e,window.addEventListener("resize",this._resizeEvent)),this._resizeEvent(),this._ctx=this._canvas.getContext(this._renderContext),this._headless=!1,this.input.setupListeners(this._canvas))},clearCanvas:function(){this._ctx&&this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)},removeCanvas:function(){this.input&&this.input.destroyListeners(),this._autoSize&&window.removeEventListener("resize",this._resizeEvent),this._createdFrontBuffer&&document.body.removeChild(this._canvas),delete this._canvas,delete this._ctx,this._ctx=$i_44,this._headless=!0},openUrl:function(t){t!==void 0&&(ige.cocoonJs&&ige.cocoonJs.detected?ige.cocoonJs.openUrl(t):window.open(t))},showWebView:function(t){if(ige.cocoonJs&&ige.cocoonJs.detected)ige.cocoonJs.showWebView(t);else{var e=document.getElementById("igeOverlay");e||(e=document.createElement("iframe"),e.id="igeOverlay",e.style.position="absolute",e.style.border="none",e.style.left="0px",e.style.top="0px",e.style.width="100%",e.style.height="100%",document.body.appendChild(e)),t!==void 0&&(e.src=t),e.style.display="block"}return this},hideWebView:function(){if(ige.cocoonJs&&ige.cocoonJs.detected)ige.cocoonJs.hideWebView();else{var t=document.getElementById("igeOverlay");t&&(t.style.display="none")}return this},layerCall:function(js){js!==void 0&&eval(js)},mousePos:function(){return this._mousePos},_resizeEvent:function(t){if(ige._autoSize){var e=window.innerWidth,i=window.innerHeight,n=ige._children,s=n.length;ige._canvas&&(e%2&&e--,i%2&&i--,ige._canvas.width=e*ige._deviceFinalDrawRatio,ige._canvas.height=i*ige._deviceFinalDrawRatio,ige._deviceFinalDrawRatio!==1&&(ige._canvas.style.width=e+"px",ige._canvas.style.height=i+"px",ige._ctx.scale(ige._deviceFinalDrawRatio,ige._deviceFinalDrawRatio))),ige.geometry=new $i_5(e,i,0);while(s--)n[s]._resizeEvent(t)}ige._resized=!0},_secondTick:function(){var t=ige;if(t._fps=t._frames,t._dps=t._dpt*t._fps,t._frames=0,t._drawCount=0,t._showStats)switch(t._showStats){case 1:t._statsDiv.innerHTML='<span class="met" title="Frames Per Second">fps: '+t._fps+'</span> <span class="met" title="Draws Per Second">dps: '+t._dps+'</span> <span class="met" title="Draws Per Tick">dpt: '+t._dpt+'</span> <span class="met" title="Time Spent Processing Tick">tps: '+t._tickTime+"ms</span>",t.network&&(t._statsDiv.innerHTML+=' <span class="met" title="Network Latency (Time From Server to This Client)">lat: '+t.network._latency+"ms</span>")}},tick:function(t,e){var i,n,s,o=ige,r=o._postTick,a=r.length;if(igeDebug.timing&&(i=(new Date).getTime()),o._state){for(e===void 0&&(e=o._ctx),requestAnimFrame(o.tick),o._frameAlternator=!o._frameAlternator,o.tickStart=t,o.tickStart-=o._clientNetDiff,o.lastTick?o.tickDelta=o.tickStart-o.lastTick:(o.lastTick=0,o.tickDelta=0),o._processBehaviours(e),o.render(e),s=0;a>s;s++)r[s]();o.lastTick=o.tickStart,o._frames++,o._dpt=o._drawCount,o._drawCount=0,o.input.tick()}o._resized=!1,igeDebug.timing&&(n=(new Date).getTime(),ige._tickTime=n-i)},fps:function(){return this._fps},dpt:function(){return this._dpt},dps:function(){return this._dps},render:function(t){var e,i;this._viewportDepth&&(igeDebug.timing?(e=(new Date).getTime(),this.depthSortChildren(),i=(new Date).getTime()-e,ige._tslt[this.id()]||(ige._tslt[this.id()]={}),ige._tslt[this.id()].depthSortChildren=i):this.depthSortChildren()),t.save(),t.translate(this.geometry.x2,this.geometry.y2);var n,s=this._children;if(s)if(n=s.length,igeDebug.timing)while(n--)t.save(),e=(new Date).getTime(),s[n].tick(t),i=(new Date).getTime()-e,s[n]&&(ige._tsit[s[n].id()]||(ige._tsit[s[n].id()]=0),ige._tslt[s[n].id()]||(ige._tslt[s[n].id()]={}),ige._tsit[s[n].id()]+=i,ige._tslt[s[n].id()].tick=i),t.restore();
else while(n--)t.save(),s[n].tick(t),t.restore();t.restore()},analyseTiming:function(){igeDebug.timing||this.log("Cannot analyse timing because the igeDebug.timing flag is not enabled so no timing data has been recorded!","warning")},sceneGraph:function(t,e){var i,n,s,o,r="";for(e===void 0&&(e=0),t||(t=ige),i=0;e>i;i++)r+="----";if(igeDebug.timing?(n="",n+="T: "+ige._tsit[t.id()],ige._tslt[t.id()]&&(typeof ige._tslt[t.id()].tick=="number"&&(n+=" | LastTick: "+ige._tslt[t.id()].tick),typeof ige._tslt[t.id()].depthSortChildren=="number"&&(n+=" | ChildDepthSort: "+ige._tslt[t.id()].depthSortChildren)),console.log(r+t.id()+" ("+t._classId+") : "+t._inView+" Timing("+n+")")):console.log(r+t.id()+" ("+t._classId+") : "+t._inView),e++,t===ige){if(s=t._children){o=s.length;while(o--)s[o]._scene._shouldRender&&(igeDebug.timing?(n="",n+="T: "+ige._tsit[s[o].id()],ige._tslt[s[o].id()]&&(typeof ige._tslt[s[o].id()].tick=="number"&&(n+=" | LastTick: "+ige._tslt[s[o].id()].tick),typeof ige._tslt[s[o].id()].depthSortChildren=="number"&&(n+=" | ChildDepthSort: "+ige._tslt[s[o].id()].depthSortChildren)),console.log(r+"----"+s[o].id()+" ("+s[o]._classId+") : "+s[o]._inView+" Timing("+n+")")):console.log(r+"----"+s[o].id()+" ("+s[o]._classId+") : "+s[o]._inView),this.sceneGraph(s[o]._scene,e+1))}}else if(s=t._children){o=s.length;while(o--)this.sceneGraph(s[o],e)}},getSceneGraphData:function(t){var e,i,n,s,o,r=[];if(t||(t=ige),e={text:t.id()+" ("+t._classId+")",parent:t._parent,id:t.id()},t===ige){if(s=t._children){o=s.length;while(o--)i={text:s[o].id()+" ("+s[o]._classId+")",parent:s[o]._parent,id:s[o].id()},s[o]._scene&&(n=this.getSceneGraphData(s[o]._scene),i.items=[n]),r.push(i)}}else if(s=t._children){o=s.length;while(o--)i=this.getSceneGraphData(s[o]),r.push(i)}return r.length>0&&(e.items=r),e},destroy:function(){this.stop(),this.isServer||this.removeCanvas(),this._super(),this.log("Engine destroy complete.")}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=$i_88);var ClientNetworkEvents={example:function(){}};typeof module!="undefined"&&module.exports!==void 0&&(module.exports=ClientNetworkEvents);var PlayerComponent=$i_2.extend({classId:"PlayerComponent",componentId:"player",init:function(t,e){this._entity=t,this._options=e,ige.input.mapAction("walkLeft",ige.input.key.left),ige.input.mapAction("walkRight",ige.input.key.right),ige.input.mapAction("walkUp",ige.input.key.up),ige.input.mapAction("walkDown",ige.input.key.down),ige.input.mapAction("jump",ige.input.key.space),this._entity.addBehaviour("playerComponent_behaviour",this._behaviour)},_behaviour:function(){var t=200/ige.cannon._scaleRatio;this._cannonBody.quaternion.x=0,this._cannonBody.quaternion.y=0,this._cannonBody.quaternion.z=0,this._cannonBody.quaternion.w=1,ige.input.actionState("walkLeft")?(this._cannonBody.velocity.set(-t,this._cannonBody.velocity.y,this._cannonBody.velocity.z),this._cannonBody.wakeUp()):ige.input.actionState("walkRight")&&(this._cannonBody.velocity.set(t,this._cannonBody.velocity.y,this._cannonBody.velocity.z),this._cannonBody.wakeUp()),ige.input.actionState("walkUp")?(this._cannonBody.velocity.set(this._cannonBody.velocity.x,-t,this._cannonBody.velocity.z),this._cannonBody.wakeUp()):ige.input.actionState("walkDown")&&(this._cannonBody.velocity.set(this._cannonBody.velocity.x,t,this._cannonBody.velocity.z),this._cannonBody.wakeUp()),ige.input.actionState("jump")&&(this._cannonBody.velocity.set(this._cannonBody.velocity.x,this._cannonBody.velocity.y,t*1.5),this._cannonBody.wakeUp())}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=PlayerComponent);var Client=$i_2.extend({classId:"Client",init:function(){ige.showStats(1);var t,e=this,i=[];this.obj=[],i[0]=new $i_48("../../assets/textures/buildings/bank1.png"),ige.on("texturesLoaded",function(){ige.createFrontBuffer(!0),ige.start(function(i){i&&(e.scene1=(new $i_64).id("scene1"),e.vp1=(new $i_63).id("vp1").autoSize(!0).scene(e.scene1).drawBounds(!0).drawBoundsData(!0).mount(ige).camera.translateTo(-50,30,0),ige.cannon.createFloor(0,0,1),e.tileMap1=(new $i_59).tileWidth(40).tileHeight(40).drawGrid(0).drawBounds(!1).drawBoundsData(!1).isometricMounts(!0).mount(e.scene1),t=-140,e.obj[0]=(new $i_53$i_20).id(1).isometric(!0).depth(0).mount(e.tileMap1).translateTo(0,0,0).size3d(160,240,40).opacity(.95).cannonBody({type:"static",mass:0,fixtures:[{shape:{type:"box"}}]}),e.obj[14]=(new $i_53$i_20).addComponent($i_11).addComponent(PlayerComponent).id(15).isometric(!0).depth(15).mount(e.tileMap1).translateTo(150,90,0).size3d(40,40,10).opacity(.95).cannonBody({type:"dynamic",mass:1,angularDamping:1,linearDamping:.05,allowSleep:!0,sleepSpeedLimit:.1,sleepTimeLimit:1e3,fixtures:[{shape:{type:"box"}}]}))})})}});typeof module!="undefined"&&module.exports!==void 0&&(module.exports=Client);var Game=$i_2.extend({classId:"Game",init:function(t,e){ige=new $i_88,ige.addComponent(Ige$i_20Component).cannon.gravity(0,0,-600).cannon.createWorld(),ige.isServer||(ige.client=new t),ige.isServer&&(ige.server=new t(e))}});if(typeof module!="undefined"&&module.exports!==void 0)module.exports=Game;else var game=new Game(Client)